<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --font-family-classic: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --font-family: var(--font-family-classic);

            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-on-bg: #ffffff;

            --card-bg: #ffffff;
            --text: #374151;
            --muted: #6b7280;
            --border: #e5e7eb;
            --surface: #f9fafb;
            --surface-hover: #f3f4f6;

            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --accent: #a855f7;

            --primary-gradient-start: #667eea;
            --primary-gradient-end: #764ba2;
            --focus-ring: rgba(102, 126, 234, 0.10);
            --button-shadow: rgba(102, 126, 234, 0.40);

            --chip-bg: var(--surface);
            --chip-border: var(--border);
            --toast-bg: rgba(0,0,0,0.85);
            --toast-text: #fff;
            --ring-size: 120px;
            --help-text: var(--muted);
            --gauge-bg: var(--card-bg);
            --gauge-wave: var(--primary);
            --gauge-wave2: var(--accent);
            --gauge-border: var(--border);
            /* Realistic tree palette */
            --tree-trunk-base: #6d4c2a;
            --tree-trunk-shadow: #4e341a;
            --leaf-light: #6fd27a;
            --leaf-mid:  #3daa52;
            --leaf-dark: #1e7032;
            --soil-top:  #9a6a49;
            --soil-mid:  #7d5237;
            --soil-deep: #5a3a27;
            --soil-speck: rgba(0,0,0,.12);
        }

        /* Sleek (experimental) theme overrides */
        body.theme-sleek {
            --font-family: 'Inter', var(--font-family-classic);
            /* Balanced deep-ink gradient (between previous + near-black) */
            --bg-gradient-start: #0b1322; /* deep navy */
            --bg-gradient-end: #192233;   /* ink blue */
            --text-on-bg: #eef2ff;

            /* Glass cards: a touch brighter for separation on dark */
            --card-bg: rgba(255, 255, 255, 0.065);
            --text: #e6edf6;
            --muted: #9fb0c3;
            --border: rgba(255, 255, 255, 0.16);
            --surface: rgba(255,255,255,0.045);
            --surface-hover: rgba(255,255,255,0.08);

            /* Vivid but not neon ‚Äî still pops */
            --primary: #b192ff; /* lively violet */
            --success: #1ee7a1; /* teal-green */
            --danger: #ff5a7a;  /* rose */
            --danger-hover: #e11d48;
            --accent: #29c7f0; /* bright cyan */

            --primary-gradient-start: #b192ff;
            --primary-gradient-end: #29c7f0;
            --focus-ring: rgba(177, 146, 255, 0.30);
            --button-shadow: rgba(177, 146, 255, 0.50);
            --toast-bg: rgba(12,17,27,0.94);
            --gauge-bg: rgba(255,255,255,0.07);
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-size: 120% 120%;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Slightly deepen Classic background to help shimmer stand out */
        body:not(.theme-sleek) {
            --bg-gradient-start: #5e6ee5; /* slightly deeper indigo */
            --bg-gradient-end: #6e56a9;   /* slightly deeper purple */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Ensure proper spacing between sections */
        .card {
            margin-bottom: 25px;
            padding: 25px;
        }
        
        /* Improve form element spacing */
        .input-group {
            margin-bottom: 20px;
        }
        
        /* Better button spacing */
        button, .btn {
            margin: 5px 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .card {
                padding: 15px;
            }
        }

        .header {
            text-align: center;
            color: var(--text-on-bg);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-in;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        @media (prefers-reduced-motion: reduce){ .coin{ animation: none; opacity:0; } }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text);
            font-size: 1.4rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .metric-card {
            text-align: center;
            position: relative;
            overflow: visible; /* allow tooltips to escape the card */
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary-gradient-start), var(--primary-gradient-end), transparent);
            background-size: 200% 100%;
            background-position: -50% 0;
            animation: shimmer 2.2s linear infinite;
            will-change: background-position;
        }

        /* Classic (non-sleek): use the same sleek-style shimmer but with a bolder palette */
        body:not(.theme-sleek) .metric-card::before {
            height: 4px;
            background: linear-gradient(90deg, transparent, #ff7a18, #3a7bd5, transparent);
            background-size: 200% 100%; /* match sleek for identical motion */
            /* no animation override here; use the global shimmer for identical timing */
            filter: saturate(1.15) contrast(1.12);
        }

        .metric-value {
            font-size: clamp(1.6rem, 5.5vw, 2.4rem);
            font-weight: 800;
            margin: 10px 0;
            transition: transform 0.3s ease;
        }

        .metric-value.positive {
            color: var(--success);
        }

        .metric-value.negative {
            color: var(--danger);
        }

        .metric-value.neutral {
            color: var(--primary);
        }

        .metric-label {
            color: var(--muted);
            font-size: clamp(0.85rem, 2.2vw, 1rem);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .input-section h2 {
            color: var(--text);
            margin-bottom: 25px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: var(--surface);
            color: var(--text);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }

        .btn {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        /* Sleek mode buttons ‚Äî ensure high contrast */
        body.theme-sleek .btn {
            color: #f8fafc;
            border: 1px solid rgba(255,255,255,0.28);
            text-shadow: 0 1px 1px rgba(0,0,0,0.35);
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }
        body.theme-sleek .btn:hover { box-shadow: 0 10px 28px rgba(0,0,0,0.45); }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--button-shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Subtle sheen effect on buttons */
        .btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.25), transparent 50%);
            transform: scale(0);
            transition: transform 0.35s ease;
        }
        .btn:hover::before { transform: scale(1); }

        .help-text { color: var(--help-text); font-size: 0.85rem; margin-top: 6px; }

        .expense-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--surface);
            transition: background 0.3s ease;
            animation: fadeIn 0.3s ease;
        }

        .expense-item:hover {
            background: var(--surface-hover);
        }

        /* Expense list layout helpers */
        .expense-item > .primary { display: flex; flex-direction: column; gap: 6px; min-width: 0; }
        .expense-item .expense-name { color: var(--muted); font-weight: 600; overflow: hidden; text-overflow: ellipsis; overflow-wrap: anywhere; }
        .expense-item .amount { font-weight: 600; color: var(--text); white-space: nowrap; }
        .expense-item .actions { display: flex; gap: 8px; }

        /* Search/sort/group controls */
        .list-controls { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin: 10px 0 6px; align-items: center; }
        .list-controls input, .list-controls select { padding: 10px 12px; border: 2px solid var(--border); background: var(--surface); color: var(--text); border-radius: 10px; font-size: 16px; }
        .group-toggle { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; color: var(--text); }

        /* Category sections */
        .category-section { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin: 8px 0; }
        .category-header { width: 100%; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 12px 14px; background: var(--surface); color: var(--text); border: 0; cursor: pointer; font-weight: 800; }
        .category-header .title { display: inline-flex; align-items: center; gap: 8px; min-width: 0; }
        .category-header .meta { color: var(--muted); font-weight: 700; text-align: right; white-space: nowrap; }
        .category-items { padding: 10px; }
        .chev { transition: transform .2s ease; }
        .collapsed .chev { transform: rotate(-90deg); }

        /* Spending Advisor */
        .advisor { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .advisor h3 { margin: 0 0 10px; color: var(--text); }
        .advisor .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .advisor .kpi { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .advisor .kpi .label { color: var(--muted); font-weight: 700; font-size: .85rem; }
        .advisor .kpi .value { color: var(--text); font-weight: 800; font-size: 1.25rem; margin-top: 6px; }
        .advisor .controls { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end; margin-top: 12px; }
        .advisor .controls .input-group { margin: 0; }
        .advisor .controls input { padding: 10px 12px; border: 2px solid var(--border); background: var(--surface); color: var(--text); border-radius: 10px; font-size: 16px; }
        .advisor .planned { margin-top: 12px; }
        .advisor .planned-item { display:flex; justify-content: space-between; align-items:center; padding:10px; border-radius:10px; background: var(--surface); border: 1px solid var(--border); margin-top:6px; }
        .advisor .planned-item .name { color: var(--text); font-weight: 700; overflow-wrap: anywhere; }
        .advisor .planned-item .amt { font-weight: 800; }
        .advisor .explain { margin-top: 10px; border: 1px dashed var(--border); border-radius: 10px; padding: 10px; background: var(--surface); }
        .advisor .explain .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 4px 0; }
        .advisor .explain .label { color: var(--muted); font-weight: 700; }
        .advisor .explain .value { color: var(--text); font-weight: 800; }
        /* Advanced settings layout: tidy and responsive */
        .advisor-advanced .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
        .advisor-advanced .input-group { margin: 0; }
        .advisor-advanced .input-group label { white-space: normal; }
        .advisor-advanced input, .advisor-advanced select { width: 100%; min-width: 0; }
        @media (max-width: 640px) {
            .advisor-advanced .form-row { grid-template-columns: 1fr !important; }
        }
        /* Ensure planned inputs size well on all screens */
        .advisor .planned .form-row.planned-row { grid-template-columns: 2fr 1fr auto; }
        .form-row .input-group { min-width: 0; }
        @media (max-width: 640px) {
            .advisor .planned .form-row.planned-row { grid-template-columns: 1fr; }
            .advisor .planned .form-row.planned-row .btn { width: 100%; }
        }
        @media (max-width: 640px) {
            .advisor .controls { grid-template-columns: 1fr; }
        }

        /* Growing Tree (Savings) */
        .tree-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .tree-wrap { position: relative; display: grid; place-items: center; }
        /* SVG-based tree container */
        .savings-tree-wrap{ width:100%; max-width:520px; aspect-ratio:16/9; position:relative; border-radius:16px; overflow:hidden; background: linear-gradient(#bfe8ff, var(--sky, #eaf6ff)); box-shadow: 0 12px 28px rgba(0,0,0,.12); }
        /* Layered, gritty soil with strata + speckles */
        .savings-tree-wrap .soil{
          position:absolute; left:0; right:0; bottom:0; height:26%;
          background:
            repeating-linear-gradient(
              to top,
              rgba(0,0,0,0.04) 0px,
              rgba(0,0,0,0.04) 3px,
              transparent 3px,
              transparent 10px
            ),
            radial-gradient(circle at 20% 70%, var(--soil-speck) 0 1px, transparent 2px),
            radial-gradient(circle at 60% 85%, var(--soil-speck) 0 1px, transparent 2px),
            radial-gradient(circle at 80% 60%, var(--soil-speck) 0 1px, transparent 2px),
            linear-gradient(to top, var(--soil-deep), var(--soil-mid) 55%, var(--soil-top));
        }
        .savings-tree-wrap svg{ position:absolute; inset:0; width:100%; height:100%; display:block; }
        /* Prefer crisp edges on SVG to avoid AA halo along vertical edges */
        .tree-svg { shape-rendering: crispEdges; }
        .tree-svg #trunk, .tree-svg #trunk * { stroke: none !important; filter: none !important; }
        .tree-svg #trunkFill { stroke: none !important; filter: none !important; }
        .savings-tree-wrap .fade-in{ animation: fadeIn .5s ease-out both; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
        /* Bind SVG parts to realistic gradients/filters */
        /* Clean-edged trunk (no glow): solid fill, no filter, no stroke */
        #SavingsTree svg .trunkFill{ fill: var(--tree-trunk-base); stroke: none; filter: none; shape-rendering: geometricPrecision; }
        /* Solid bark color for strokes; avoids gradient fringing */
        #SavingsTree svg .trunk   { stroke: var(--tree-trunk-base); filter: none; vector-effect: non-scaling-stroke; }
        #SavingsTree svg .branch  { stroke: var(--tree-trunk-base); filter: none; vector-effect: non-scaling-stroke; }
        /* Leaves keep rich gradients */
        #SavingsTree svg .leafFill{ fill:   url(#leafGrad); }
        #SavingsTree svg .leafShade{fill:   url(#leafGradDark); }
        #SavingsTree svg #canopy  { filter: url(#leafShadow); }
        #SavingsTree svg #seed circle { fill: var(--tree-trunk-shadow); }

        /* === Ultra Real Tree & Ground (override-ready) === */
        :root{
          --tree-trunk-base:#6d4c2a;
          --tree-trunk-shadow:#4e341a;
          --leaf-light:#6fd27a;
          --leaf-mid:#3daa52;
          --leaf-dark:#1e7032;
          --soil-top:#9a6a49;
          --soil-mid:#7d5237;
          --soil-deep:#5a3a27;
          --soil-speck:rgba(0,0,0,.12);
        }
        #SavingsTree .soil{
          background:
            repeating-linear-gradient(to top,rgba(0,0,0,.04) 0px,rgba(0,0,0,.04) 3px,transparent 3px,transparent 10px),
            radial-gradient(circle at 20% 72%,var(--soil-speck) 0 1px,transparent 2px),
            radial-gradient(circle at 64% 86%,var(--soil-speck) 0 1px,transparent 2px),
            radial-gradient(circle at 82% 63%,var(--soil-speck) 0 1px,transparent 2px),
            linear-gradient(to top,var(--soil-deep),var(--soil-mid) 55%,var(--soil-top));
        }
        #SavingsTree svg .trunkFill{ fill:url(#trunkGrad); filter:url(#barkNoise); }
        #SavingsTree svg .branch{ stroke:url(#trunkGrad); }
        #SavingsTree svg .leafFill{ fill:url(#leafGrad); }
        #SavingsTree svg .leafShade{ fill:url(#leafGradDark); }
        #SavingsTree svg #canopy{ filter:url(#leafShadow); }
        #SavingsTree svg #groundShadow{ fill:rgba(0,0,0,.15); }
        .tree-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px; }
        .tree-kpis .k { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
        .tree-kpis .k .label { color: var(--muted); font-weight: 700; font-size: .85rem; }
        .tree-kpis .k .value { color: var(--text); font-weight: 800; font-size: 1.1rem; margin-top: 4px; }
        .tree-controls { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end; margin-top: 12px; }
        .tree-controls .input-group { margin: 0; }
        .tree-controls input { padding: 10px 12px; border: 2px solid var(--border); background: var(--surface); color: var(--text); border-radius: 10px; font-size: 16px; }
        @media (max-width: 640px) { 
            .tree-controls { grid-template-columns: 1fr; }
            .tree-controls .btn, .tree-controls .delete-btn { width: 100%; }
        }

        /* Mobile adjustments to avoid overlap and keep symmetry */
        @media (max-width: 640px) {
            .expense-item { flex-wrap: wrap; align-items: flex-start; }
            .expense-item > .primary { flex: 1 1 100%; }
            .expense-item .amount { order: 2; }
            .expense-item .actions { order: 3; width: 100%; }
            .expense-item .actions .btn,
            .expense-item .actions .delete-btn { flex: 1 1 50%; }
            .list-controls { grid-template-columns: 1fr; }
            .category-header { grid-template-columns: 1fr; }
            .category-header .meta { text-align: left; }
        }

        /* Chips */
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; margin-bottom: 4px; }
        .chip { 
            border: 1px solid color-mix(in srgb, var(--chip-color, var(--primary)) 50%, var(--chip-border));
            background: color-mix(in srgb, var(--chip-color, var(--primary)) 18%, transparent);
            color: var(--text);
            padding: 6px 12px; border-radius: 999px; cursor: pointer; font-weight: 700; letter-spacing:.2px;
            transition: transform 0.15s ease, background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, border-color .2s ease;
        }
        .chip:hover { transform: translateY(-1px); background: color-mix(in srgb, var(--chip-color, var(--primary)) 26%, transparent); }
        .chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        /* Make active chip vivid and readable */
        .chip.active { 
            background: var(--chip-color);
            color: var(--text-on-bg);
            border-color: transparent;
            box-shadow: 0 6px 16px rgba(0,0,0,0.18);
        }
        /* Specifically help the 'All' tab pop in Classic */
        body:not(.theme-sleek) .chip[data-label="All"] { border-color: color-mix(in srgb, var(--primary) 55%, #9ca3af); }
        body:not(.theme-sleek) .chip[data-label="All"].active { box-shadow: 0 6px 16px rgba(17,24,39,0.15); }

        /* Link-styled button for subtle actions */
        .text-btn { background: none; border: none; color: var(--primary); font-weight: 700; cursor: pointer; padding: 0; margin: 4px 0 0; }
        .text-btn:hover { text-decoration: underline; }

        .expense-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .delete-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        body.theme-sleek .delete-btn { box-shadow: 0 6px 16px rgba(0,0,0,0.35); text-shadow: 0 1px 1px rgba(0,0,0,.25); }

        .delete-btn:hover {
            background: var(--danger-hover);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 20px;
        }
        /* Fluid gauge */
        .liquid-wrap { position: relative; display: grid; place-items: center; }
        #balanceCanvas { width: 100%; max-width: 420px; height: auto; display: block; margin: 0 auto; }
        /* Gauge label (DOM overlay above canvas) */
        .gauge-label { position: absolute; left: 0; right: 0; top: var(--gauge-center-top, 50%); transform: translateY(-50%); text-align: center; color: var(--text); font-weight: 800; pointer-events: none; z-index: 2; }
        .gauge-label .big { font-size: 1.5rem; letter-spacing: 0.5px; line-height: 1.05; font-weight: 800; }
        .gauge-label .small { display: block; margin-top: 2px; font-size: 0.8rem; color: var(--muted); font-weight: 600; line-height: 1; }

        /* Classic Mode: keep gauge label high-contrast on light background */
        body:not(.theme-sleek) .gauge-label .big {
            color: var(--text); /* dark text for empty/low fill readability */
            -webkit-text-stroke: 0; /* remove heavy edge on light bg */
            text-shadow: none;
        }
        body:not(.theme-sleek) .gauge-label .small {
            color: var(--muted);
            text-shadow: none;
        }

        /* Sleek Mode: ensure strong contrast over vibrant waves */
        body.theme-sleek .gauge-label .big {
            color: #f8fafc; /* near-white for dark background */
            -webkit-text-stroke: 0.6px rgba(0,0,0,0.45); /* thin dark edge for bright wave overlap */
            text-shadow: 0 1px 2px rgba(0,0,0,0.55), 0 0 6px rgba(0,0,0,0.25);
        }
        body.theme-sleek .gauge-label .small {
            color: #e2e8f0; /* light gray */
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .goal-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin-top: 14px; }

        /* Responsive form row for inputs */
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .form-row .input-group { margin: 0; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0%   { background-position: -50% 0; }
            100% { background-position: 150% 0; }
        }

        @media (prefers-reduced-motion: reduce) {
            .metric-card::before { animation: none; background-position: 150% 0; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            .form-row { grid-template-columns: 1fr; }
            .form-row .btn { width: 100%; }
        }

        /* Edit row (original inline layout) */
        .expense-item .edit-inline { display: flex; gap: 8px; align-items: center; width: 100%; }
        .expense-item .input-group { min-width: 0; }
        .expense-item .input-group input,
        .expense-item .input-group select { width: 100%; }
        .expense-item .actions { display: flex; gap: 8px; align-items: center; }
        @media (max-width: 640px) {
            .expense-item .edit-inline { flex-wrap: wrap; }
            .expense-item .input-group { flex: 1 1 100% !important; }
            .expense-item .actions { width: 100%; }
            .expense-item .actions .btn,
            .expense-item .actions .delete-btn { flex: 1 1 auto; }
        }

        /* Sleek theme extras */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body.theme-sleek {
            animation: gradientShift 20s ease infinite;
        }

        body.theme-sleek .card,
        body.theme-sleek .input-section,
        body.theme-sleek .chart-container {
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        /* Progress ring */
        .progress-ring { position: relative; width: var(--ring-size); height: var(--ring-size); margin: 10px auto 0; }
        .progress-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { stroke: rgba(0,0,0,0.08); }
        body.theme-sleek .ring-bg { stroke: rgba(255,255,255,0.12); }
        .ring-progress { stroke: var(--primary); transition: stroke-dashoffset 400ms ease, stroke 200ms ease; }
        .progress-value { position: absolute; inset: 0; display: grid; place-items: center; font-weight: 700; color: var(--text); }

        /* Toasts */
        #toastContainer { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 10000; pointer-events: none; }
        .toast { background: var(--toast-bg); color: var(--toast-text); padding: 10px 14px; border-radius: 10px; opacity: 0; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; font-weight: 600; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: linear-gradient(135deg, var(--success), var(--accent)); }
        .toast.warn { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #7f1d1d); }

        /* Info tooltip icon */
        .info { display:inline-flex; align-items:center; justify-content:center; width:1.1em; height:1.1em; border-radius:50%; background: var(--surface); color: var(--muted); border:1px solid var(--border); font-size:0.85em; margin-left:6px; cursor:help; position:relative; user-select:none; }
        .metric-card .info { position: absolute; right: 10px; top: 10px; font-size: 0.85em; width: 1.2em; height: 1.2em; }
        .info:hover { color: var(--text); }
        .info:focus { outline: none; box-shadow: 0 0 0 3px var(--focus-ring); }
        /* Disable pseudo-tooltips; JS-managed layer used for better viewport clamp */
        .info::after { content: none !important; }

        /* Global tooltip layer (fixed to viewport) */
        #tipLayer { position: fixed; z-index: 10000; pointer-events: none; background: var(--toast-bg); color: var(--toast-text); padding: 10px 12px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); max-width: min(320px, 92vw); display: none; font-weight: 700; font-size: 0.9rem; }

        /* KPI sizing (mobile friendly) */
        .advisor .kpi .value { font-size: clamp(1.05rem, 4.2vw, 1.25rem); }
        .advisor .kpi .label { font-size: clamp(0.8rem, 2.5vw, 0.9rem); }

        @media (max-width: 640px) {
            .metric-card { min-height: 140px; }
        }

        /* Ripple */
        .btn { position: relative; overflow: hidden; }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); background: rgba(255,255,255,0.5); animation: ripple .6s linear; pointer-events: none; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* Shake */
        .shake { animation: shake .4s; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }

        /* Metric pop */
        .pop { animation: pop .35s ease; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }

        /* Reveal on scroll */
        .card, .chart-container { opacity: 0; transform: translateY(16px); transition: opacity .4s ease, transform .4s ease; }
        .in-view { opacity: 1 !important; transform: translateY(0) !important; }

        /* Emoji burst */
        .burst { position: fixed; z-index: 9999; transition: transform .8s ease, opacity .8s ease; will-change: transform, opacity; }

        /* Theme toggle control */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .theme-toggle .toggle-label { font-weight: 600; font-size: 0.9rem; }
        .theme-toggle .toggle-icon { font-size: 1rem; line-height: 1; opacity: .95; margin: 0 6px 0 2px; position: relative; display: inline-block; }
        .theme-toggle .toggle-icon.moon { filter: drop-shadow(0 0 0 rgba(139,92,246,0)); }

        /* Toggle icon animations (GPU-friendly, smooth) */
        @keyframes moonGlow {
            0% { transform: translateZ(0) scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(139,92,246,0)); }
            35% { transform: translateZ(0) scale(1.1) rotate(-6deg); filter: drop-shadow(0 0 10px rgba(139,92,246,0.75)) drop-shadow(0 0 16px rgba(6,182,212,0.55)); }
            70% { transform: translateZ(0) scale(1.04) rotate(2deg); filter: drop-shadow(0 0 6px rgba(139,92,246,0.5)); }
            100% { transform: translateZ(0) scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(139,92,246,0)); }
        }
        .glow-pulse { animation: moonGlow 900ms cubic-bezier(.22,.61,.36,1); will-change: transform, filter; }
        .toggle-icon.moon.glow-pulse::before { content: ""; position: absolute; inset: -10px; border-radius: 50%; background: radial-gradient(circle, rgba(139,92,246,0.28), rgba(6,182,212,0.0) 65%); filter: blur(6px); opacity: 0; animation: moonAura 900ms ease-out; pointer-events: none; }
        .toggle-icon.moon.glow-pulse::after { content: ""; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid rgba(139,92,246,0.5); opacity: 0; animation: moonRing 900ms ease-out; pointer-events: none; }
        @keyframes moonAura { 0% { opacity: 0; transform: scale(0.85); } 40% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(1.25); } }
        @keyframes moonRing { 0% { opacity: 0; transform: scale(0.9); } 35% { opacity: .9; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1.2); } }

        /* Sparkle particles for bursts (used by Sleek icon) */
        .sparkle-burst { animation: none; }
        .spark-particle { position: absolute; left: 50%; top: 50%; width: 6px; height: 6px; border-radius: 50%; transform: translate(-50%, -50%) scale(.4); opacity: 0.95; pointer-events: none; will-change: transform, opacity; }
        .spark-particle::after { content: ""; position: absolute; inset: -2px; border-radius: inherit; box-shadow: 0 0 8px currentColor; }
        @keyframes sparkFly {
            0% { transform: translate(-50%, -50%) scale(.4) rotate(0deg); opacity: 1; }
            70% { transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(1) rotate(var(--rot, 0deg)); opacity: 1; }
            100% { transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(.25) rotate(var(--rot, 0deg)); opacity: 0; }
        }
        .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--surface); border: 1px solid var(--border); transition: .2s; border-radius: 999px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; top: 50%; transform: translateY(-50%); background-color: white; border-radius: 50%; transition: .2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .slider::after { content: ""; position: absolute; inset: 0; border-radius: inherit; opacity: 0; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.35) 40%, transparent 60%); transform: translateX(-30%); }
        input:checked + .slider { background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); border-color: transparent; }
        input:checked + .slider::after { animation: sheen 650ms ease-out; }
        input:checked + .slider:before { transform: translate(20px, -50%); }
        @keyframes sheen { 0% { opacity: 0; transform: translateX(-30%); } 30% { opacity: .8; } 100% { opacity: 0; transform: translateX(130%); } }

        /* (Removed) desktop toggle help bubble to keep UI minimal */

        /* Mobile-friendly placement for toggles */
        @media (max-width: 640px) {
            /* Move toasts to the top, don‚Äôt block toggles */
            #toastContainer { top: max(10px, env(safe-area-inset-top)); bottom: auto; right: 50%; left: 50%; transform: translateX(-50%); width: min(92vw, 420px); align-items: center; }
            .theme-toggle {
                top: auto;
                bottom: 12px;
                right: 12px;
                left: auto;
                padding: 6px 8px;
                gap: 6px;
                border-radius: 999px;
            }
            /* On mobile: hide long labels but show icons for clarity */
            .theme-toggle .toggle-label { display: none; }
            .theme-toggle .toggle-icon { display: inline-block; }
            .switch { width: 42px; height: 24px; }
            .slider:before { width: 18px; height: 18px; left: 3px; }
            input:checked + .slider:before { transform: translate(18px, -50%); }
            /* help bubble removed */
        }
    </style>
</head>
<body>
    <div class="theme-toggle" title="Quick settings">
        <span class="toggle-icon moon" aria-hidden="true" title="Sleek Mode">üåô</span>
        <label class="switch" title="Sleek Mode: modern dark glass UI (visual only)">
            <input type="checkbox" id="themeToggle" aria-label="Toggle Sleek Mode (modern dark look)">
            <span class="slider"></span>
        </label>
        <span class="toggle-label"><span id="modeName">Classic</span> Mode</span>
    </div>
    <div class="container">
        <div class="header">
            <h1>üí∞ Financial Tracker Pro</h1>
            <p>Your complete financial clarity dashboard</p>
        </div>

        <div class="dashboard">
            <div class="card metric-card">
                <div class="metric-label">Monthly Income</div>
                <span class="info" tabindex="0" aria-label="What is Monthly Income?" data-tip="Money you get this month (from income or checks).">‚ìò</span>
                <div class="metric-value neutral" id="incomeDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Yearly Estimate</div>
                <span class="info" tabindex="0" aria-label="What is Yearly Estimate?" data-tip="Estimated yearly income: Monthly Income √ó 12.">‚ìò</span>
                <div class="metric-value neutral" id="yearlyDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Total Expenses</div>
                <span class="info" tabindex="0" aria-label="What are Total Expenses?" data-tip="Sum of all the expenses you added for this period.">‚ìò</span>
                <div class="metric-value negative" id="expensesDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Savings</div>
                <span class="info" tabindex="0" aria-label="What are Savings?" data-tip="Your current savings balance (from the Savings Tree).">‚ìò</span>
                <div class="metric-value positive pulse" id="savingsDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Leftover This Month</div>
                <span class="info" tabindex="0" aria-label="What is Leftover?" data-tip="Leftover = Monthly Income ‚àí Total Expenses. A simple monthly view.">‚ìò</span>
                <div class="metric-value positive" id="disposableDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Account Balance</div>
                <span class="info" tabindex="0" aria-label="What is Balance?" data-tip="What you have right now. You can update it below.">‚ìò</span>
                <div class="metric-value positive" id="balanceDisplay">$0</div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Spend Rate</div>
                <span class="info" tabindex="0" aria-label="What is Spend Rate?" data-tip="Percent of income you've spent so far: Expenses √∑ Income.">‚ìò</span>
                <div class="progress-ring" id="spendRing">
                    <svg width="120" height="120">
                        <circle class="ring-bg" cx="60" cy="60" r="52" stroke-width="12" fill="none" />
                        <circle class="ring-progress" cx="60" cy="60" r="52" stroke-width="12" fill="none" stroke-linecap="round" />
                    </svg>
                    <div class="progress-value" id="spendRateLabel">0%</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2 style="margin-bottom: 20px; color: var(--text);">Financial Input</h2>

            <div class="input-group">
                <label for="balanceInput">Current Account Balance ($)</label>
                <div class="form-row" style="grid-template-columns: 1fr auto;">
                    <input type="number" id="balanceInput" placeholder="0.00" step="0.01">
                    <button class="btn" id="setBalanceBtn">Set</button>
                </div>
                <div class="help-text">Auto-updates when you add/delete expenses. You can edit anytime.</div>
            </div>

            <div class="input-group">
                <label for="incomeType">Income Input Type</label>
                <select id="incomeType">
                    <option value="monthly">Monthly Income</option>
                    <option value="checks">Checks</option>
                </select>
            </div>

            <div class="input-group" id="monthlySection">
                <label for="income">Monthly Income ($)</label>
                <input type="number" id="income" placeholder="Enter your monthly income" step="0.01">
            </div>

            <div id="checkSection" style="display: none;">
                <h3 style="margin: 25px 0 15px; color: var(--text);">Add Check</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label for="checkNumber">Check #</label>
                        <input type="text" id="checkNumber" placeholder="12345">
                    </div>
                    <div class="input-group">
                        <label for="checkAmount">Amount ($)</label>
                        <input type="number" id="checkAmount" placeholder="0.00" step="0.01">
                    </div>
                    <button class="btn" onclick="addCheck(event)">Add Check</button>
                </div>
                <div class="expense-list" id="checkList" style="margin-top: 20px;"></div>
            </div>

            <h3 style="margin: 25px 0 15px; color: var(--text);">Add Expense</h3>
            <div class="form-row">
                <div class="input-group">
                    <label for="expenseName">Name</label>
                    <input type="text" id="expenseName" placeholder="e.g., Coffee, Rent, Gym">
                </div>
                <div class="input-group">
                    <label for="expenseAmount">Amount ($)</label>
                    <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="expenseCategory">Category</label>
                    <select id="expenseCategory">
                        <option value="Housing">üè† Housing</option>
                        <option value="Food">üçî Food</option>
                        <option value="Transport">üöó Transport</option>
                        <option value="Utilities">üí° Utilities</option>
                        <option value="Entertainment">üéÆ Entertainment</option>
                        <option value="Healthcare">üè• Healthcare</option>
                        <option value="Shopping">üõçÔ∏è Shopping</option>
                        <option value="Other">üì¶ Other</option>
                    </select>
                    <button type="button" id="toggleCustomCategory" class="text-btn">or name your own</button>
                </div>
                <button class="btn" onclick="addExpense(event)">Add Expense</button>
            </div>
            <div class="input-group" id="customCategoryGroup" style="display:none; margin-top:10px;">
                <label for="expenseCategoryCustom">Custom Category</label>
                <input type="text" id="expenseCategoryCustom" placeholder="Enter a category name">
            </div>
            
            <div class="chip-group" id="filterChips"></div>
            <div class="list-controls" id="listControls">
                <input type="search" id="expenseSearch" placeholder="Search expenses" />
                <select id="expenseSort" aria-label="Sort expenses">
                    <option value="recent">Recent</option>
                    <option value="amountDesc">Amount: High ‚Üí Low</option>
                    <option value="amountAsc">Amount: Low ‚Üí High</option>
                    <option value="nameAsc">Name: A ‚Üí Z</option>
                    <option value="nameDesc">Name: Z ‚Üí A</option>
                </select>
                <label class="group-toggle"><input type="checkbox" id="groupByCategory"> Group by category</label>
            </div>
            <div class="expense-list" id="expenseList"></div>
        </div>

            <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">üìä Income vs Expenses</h3>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">üìà Expense Categories</h3>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">üíß Balance Gauge</h3>
                <div class="liquid-wrap">
                    <canvas id="balanceCanvas" width="420" height="220"></canvas>
                    <div class="gauge-label">
                        <span class="big" id="gaugeMain">0%</span>
                        <span class="small" id="gaugeSub">of goal</span>
                    </div>
                </div>
                <div class="goal-row">
                    <input type="number" id="balanceGoalInput" placeholder="Set balance goal ($)" step="0.01" style="border:2px solid var(--border); background:var(--surface); color:var(--text); border-radius:10px; padding:10px 12px;">
                    <button class="btn" id="setGoalBtn">Set Goal</button>
                </div>
            </div>
        </div>
        
        <!-- Spending Advisor -->
        <div class="input-section advisor" id="advisorSection">
            <h2 style="margin-bottom: 10px; color: var(--text);">Spending Advisor</h2>
            <div class="grid" style="margin-bottom: 8px;">
                <div class="kpi">
                    <div class="label">Safe To Spend Today <span class="info" tabindex="0" aria-label="Safe To Spend Today" data-tip="What‚Äôs safe to spend after we set aside a cushion and your upcoming bills (and usual spending, if enabled).">‚ìò</span></div>
                    <div class="value" id="kpiSafeNow">$0.00</div>
                </div>
                <div class="kpi">
                    <div class="label">Per Day <span class="info" tabindex="0" aria-label="Per Day" data-tip="Safe To Spend divided by the days left this month.">‚ìò</span></div>
                    <div class="value" id="kpiPerDay">$0.00</div>
                </div>
                <div class="kpi">
                    <div class="label">Safety Cushion <span class="info" tabindex="0" aria-label="Safety Cushion" data-tip="A percentage we set aside as a buffer so you don‚Äôt overspend.">‚ìò</span></div>
                    <div class="value" id="kpiReserve">$0.00</div>
                </div>
                <div class="kpi">
                    <div class="label">Upcoming Bills <span class="info" tabindex="0" aria-label="Upcoming Bills" data-tip="Bills you add below in Planned Upcoming Expenses.">‚ìò</span></div>
                    <div class="value" id="kpiPlanned">$0.00</div>
                </div>
            </div>
            <div class="help-text" style="margin: 6px 0 8px;">Quick guide: We look at your balance, set aside a safety cushion, subtract upcoming bills (and typical spending for the rest of the month if enabled), and show what‚Äôs safe to spend.</div>
            <div class="controls">
                <div class="input-group">
                    <label for="reservePercent">Safety cushion (%) <span class="info" tabindex="0" aria-label="What is the Safety Cushion?" data-tip="We keep this percent of your money set aside so you don‚Äôt spend it by mistake. Bigger number = more saved, less to spend each day. 30% is a good starting point. You can change it anytime.">‚ìò</span></label>
                    <input type="number" id="reservePercent" min="0" max="90" step="1" placeholder="e.g., 30">
                </div>
                <button class="btn" id="applyReserveBtn">Apply</button>
            </div>
            <details class="advisor-advanced" style="margin-top:8px;">
                <summary style="cursor:pointer; font-weight:700; color:var(--text);">Advanced settings</summary>
                <div class="form-row" style="grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                    <div class="input-group">
                        <label for="reserveBasis">Cushion based on</label>
                        <select id="reserveBasis">
                            <option value="balance">Balance</option>
                            <option value="income">Income</option>
                            <option value="both" selected>Balance + Income</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="useProjection">Account for usual spending</label>
                        <select id="useProjection">
                            <option value="on" selected>On</option>
                            <option value="off">Off</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                    <div class="input-group">
                        <label for="advisorCycle">Budget period</label>
                        <select id="advisorCycle">
                            <option value="month" selected>This month</option>
                            <option value="paycheck">Until next paycheck</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="payFrequency">Pay schedule</label>
                        <select id="payFrequency">
                            <option value="weekly">Weekly</option>
                            <option value="biweekly" selected>Bi-weekly (every 2 weeks)</option>
                            <option value="semimonthly">Semimonthly (1st & 15th)</option>
                            <option value="monthly">Monthly (pick a day)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                    <div class="input-group">
                        <label for="payAnchor">Last payday</label>
                        <input type="date" id="payAnchor" />
                    </div>
                    <div class="input-group">
                        <label for="payMonthlyDay">Monthly payday (1‚Äì28)</label>
                        <input type="number" id="payMonthlyDay" min="1" max="28" placeholder="e.g., 15" />
                    </div>
                </div>
            </details>
            <div class="planned">
                <h3 style="margin: 12px 0 8px; color: var(--text); font-size:1.1rem;">Planned Upcoming Expenses</h3>
                <div class="form-row planned-row">
                    <div class="input-group"><label>Name</label><input type="text" id="plannedName" placeholder="e.g., Car insurance"/></div>
                    <div class="input-group"><label>Amount ($)</label><input type="number" step="0.01" id="plannedAmount" placeholder="0.00"/></div>
                    <button class="btn" id="addPlannedBtn">Add Planned</button>
                </div>
                <div id="plannedList"></div>
                <div class="help-text">Safe To Spend = Balance ‚àí Upcoming Bills ‚àí Safety Cushion ‚àí Expected Rest‚Äëof‚ÄëMonth Spending (optional).</div>
                <div class="explain" id="advisorExplain">
                    <div class="row"><div class="label">Balance</div><div class="value" id="xBalance">$0.00</div></div>
                    <div class="row"><div class="label">Safety cushion (<span id="xBasis">Both</span>)</div><div class="value" id="xReserve">$0.00</div></div>
                    <div class="row"><div class="label">Upcoming bills</div><div class="value" id="xPlanned">$0.00</div></div>
                    <div class="row"><div class="label">Expected rest‚Äëof‚Äëmonth</div><div class="value" id="xProjected">$0.00</div></div>
                    <div class="row"><div class="label">Days left in period</div><div class="value" id="xDaysLeft">0</div></div>
                    <div class="row"><div class="label">Daily pace used</div><div class="value" id="xDailyPace">$0.00/day</div></div>
                    <div class="row"><div class="label">Safe to spend today</div><div class="value" id="xSafe">$0.00</div></div>
                    <div class="row"><div class="label">Per day</div><div class="value" id="xPerDay">$0.00</div></div>
                </div>
            </div>
        </div>

        <!-- Savings: Growing Tree -->
        <div class="input-section tree-card" id="savingsSection">
            <h2 style="margin-bottom: 10px; color: var(--text);">Growing Tree ‚Äî Savings</h2>
            <div class="tree-wrap">
                <div class="savings-tree-wrap" id="SavingsTree">
                  <div class="soil"></div>
                  <svg class="tree-svg" viewBox="0 0 100 100" aria-label="Savings growth tree">
                    <!-- Realistic paints & filters -->
                    <defs>
                      <!-- Clip to keep trunk strictly above ground line (y=84) -->
                      <clipPath id="aboveGroundClip">
                        <rect x="0" y="0" width="100" height="84" />
                      </clipPath>
                      <linearGradient id="trunkGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%"   stop-color="var(--tree-trunk-base)"/>
                        <stop offset="60%"  stop-color="var(--tree-trunk-base)"/>
                        <stop offset="100%" stop-color="var(--tree-trunk-shadow)"/>
                      </linearGradient>
                      <radialGradient id="leafGrad" cx="35%" cy="35%" r="70%">
                        <stop offset="0%"   stop-color="var(--leaf-light)"/>
                        <stop offset="55%"  stop-color="var(--leaf-mid)"/>
                        <stop offset="100%" stop-color="var(--leaf-dark)"/>
                      </radialGradient>
                      <radialGradient id="leafGradDark" cx="65%" cy="65%" r="80%">
                        <stop offset="0%"   stop-color="var(--leaf-mid)"/>
                        <stop offset="100%" stop-color="var(--leaf-dark)"/>
                      </radialGradient>
                      <filter id="leafShadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="1.2" result="blur"/>
                        <feOffset in="blur" dx="0" dy="1.2" result="off"/>
                        <feMerge>
                          <feMergeNode in="off"/>
                          <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                      </filter>
                      <filter id="barkNoise" x="-10%" y="-10%" width="120%" height="120%">
                        <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" result="noise"/>
                        <feColorMatrix in="noise" type="matrix"
                          values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .35 0" result="alpha"/>
                        <feBlend in="SourceGraphic" in2="alpha" mode="multiply"/>
                      </filter>
                    </defs>
                    <g id="treeGroup">
                      <!-- Ground shadow under canopy -->
                      <ellipse id="groundShadow" cx="50" cy="86.5" rx="4" ry="1.6" opacity="0" />
                      <!-- Seed -->
                      <g id="seed" class="fade-in">
                        <circle cx="50" cy="84" r="3.6"></circle>
                        <ellipse cx="50" cy="86.2" rx="6" ry="1.8" fill="rgba(0,0,0,.08)"/>
                      </g>
                      <!-- Sprout -->
                      <g id="sprout">
                        <path id="sproutStem" class="trunk" d="M50,84 L50,84" stroke-width="1.6" stroke-linecap="round" fill="none"/>
                        <path id="sproutLeaf" class="leafFill" d="M50,82 C51,81.6 52,81.2 52,80.6 C52,80 51,80 50,80.4 C49,80.8 48,81.2 48,81.8 C48,82.4 49,82.4 50,82 Z" opacity="0"/>
                      </g>
                      <!-- Branches (drawn before trunk so trunk overlays edges) -->
                      <g id="branches" stroke-linecap="round" fill="none" opacity="0">
                        <path id="b1" class="branch" d="M50,74 C48,72 46,70 44,68" stroke-width="2.2"/>
                        <path id="b2" class="branch" d="M50,70 C52,68 54,66 56,64" stroke-width="2.0"/>
                        <path id="b3" class="branch" d="M50,65 C48,63 46,61 44,59" stroke-width="1.9"/>
                        <path id="b4" class="branch" d="M50,61 C52,59 54,57 56,55" stroke-width="1.7"/>
                      </g>
                      <!-- Trunk (filled shape overlays branches for clean edge) -->
                      <path id="trunkFill" class="trunkFill" d="M48,84 L52,84 L52,84 L48,84 Z" clip-path="url(#aboveGroundClip)"/>
                      <!-- Canopy -->
                      <g id="canopy" opacity="0">
                        <circle id="c1" class="leafFill"  cx="50" cy="56" r="0"/>
                        <circle id="c2" class="leafFill"  cx="43" cy="58" r="0"/>
                        <circle id="c3" class="leafFill"  cx="57" cy="58" r="0"/>
                        <circle id="c4" class="leafShade" cx="46" cy="52" r="0"/>
                        <circle id="c5" class="leafShade" cx="54" cy="52" r="0"/>
                        <circle id="c6" class="leafFill"  cx="39" cy="55" r="0"/>
                        <circle id="c7" class="leafFill"  cx="61" cy="55" r="0"/>
                        <circle id="c8" class="leafShade" cx="45" cy="60" r="0"/>
                        <circle id="c9" class="leafShade" cx="55" cy="60" r="0"/>
                      </g>
                      <!-- Top highlight -->
                      <g id="shine" opacity="0">
                        <circle cx="47" cy="53" r="10" fill="rgba(255,255,255,.12)"/>
                      </g>
                    </g>
                  </svg>
                </div>
            </div>
            <div class="tree-kpis">
                <div class="k"><div class="label">Saved</div><div class="value" id="savedNow">$0.00</div></div>
                <div class="k"><div class="label">Goal</div><div class="value" id="savedGoal">$0.00</div></div>
                <div class="k"><div class="label">Progress</div><div class="value" id="savedPct">0%</div></div>
            </div>
        <div class="tree-controls">
            <div class="input-group">
                <label for="savingsGoalInput">Savings Goal ($)</label>
                <input type="number" id="savingsGoalInput" step="0.01" placeholder="e.g., 5000.00" />
            </div>
            <button class="btn" id="setSavingsGoalBtn">Set Goal</button>
            <div></div>
            <div class="input-group">
                <label for="savingsAmountInput">Amount ($)</label>
                <input type="number" id="savingsAmountInput" step="0.01" placeholder="0.00" />
            </div>
            <button class="btn" id="depositSavingsBtn">Deposit</button>
            <button class="delete-btn" id="withdrawSavingsBtn">Withdraw</button>
            <div class="input-group">
                <label for="savingsSetInput">Current Saved ($)</label>
                <input type="number" id="savingsSetInput" step="0.01" placeholder="0.00" />
            </div>
            <button class="btn" id="updateSavedBtn">Update Saved</button>
            <div></div>
        </div>
        <div class="help-text" style="margin-top:8px;">Deposits move money from Balance into Savings. Withdrawals move it back to Balance.</div>
      </div>
    </div>

    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
    <div id="tipLayer" role="tooltip" aria-hidden="true"></div>

    <script>
        // Data storage
        let financialData = {
            income: 0,
            expenses: [],
            categories: {},
            checks: [],
            balance: 0,
            planned: []
        };

        function saveData() {
            try {
                localStorage.setItem('financialData', JSON.stringify(financialData));
                localStorage.setItem('balance', String(financialData.balance));
                localStorage.setItem('savings', String(financialData.savings || 0));
                localStorage.setItem('savingsGoal', String(financialData.savingsGoal || 0));
            } catch (e) {
                console.error('Failed to save data', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('financialData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(financialData, parsed);
                    if (!Array.isArray(financialData.planned)) financialData.planned = [];
                    if (typeof financialData.savings !== 'number') {
                        const s = parseFloat(localStorage.getItem('savings')||'');
                        financialData.savings = isNaN(s)?0:s;
                    }
                    if (typeof financialData.savingsGoal !== 'number') {
                        const g = parseFloat(localStorage.getItem('savingsGoal')||'');
                        financialData.savingsGoal = isNaN(g)?0:g;
                    }
                } else {
                    const savedBalance = localStorage.getItem('balance');
                    if (savedBalance !== null) {
                        financialData.balance = parseFloat(savedBalance) || 0;
                    }
                    const s = parseFloat(localStorage.getItem('savings')||'');
                    financialData.savings = isNaN(s)?0:s;
                    const g = parseFloat(localStorage.getItem('savingsGoal')||'');
                    financialData.savingsGoal = isNaN(g)?0:g;
                }
            } catch (e) {
                console.error('Failed to load data', e);
            }
        }

        // Category colors
        const categoryColors = {
            'Housing': '#ef4444',
            'Food': '#f97316',
            'Transport': '#eab308',
            'Utilities': '#84cc16',
            'Entertainment': '#06b6d4',
            'Healthcare': '#8b5cf6',
            'Shopping': '#ec4899',
            'Other': '#6b7280'
        };

        function getRandomColor() {
            return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
        }

        // Initialize charts
        const barCtx = document.getElementById('barChart').getContext('2d');
        const pieCtx = document.getElementById('pieChart').getContext('2d');

        // Chart palette helper (theme-aware)
        function getCssVar(name) { return getComputedStyle(document.body).getPropertyValue(name).trim(); }
        function hexToRgba(hex, alpha) {
            const h = hex.replace('#','');
            const n = parseInt(h, 16);
            const r = (n >> 16) & 255;
            const g = (n >> 8) & 255;
            const b = n & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        const barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expenses', 'Savings', 'Disposable', 'Balance'],
                datasets: [{
                    label: 'Amount ($)',
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: [
                        hexToRgba(getCssVar('--primary') || '#667eea', 0.8),
                        hexToRgba(getCssVar('--danger') || '#ef4444', 0.8),
                        hexToRgba(getCssVar('--success') || '#10b981', 0.8),
                        hexToRgba(getCssVar('--accent') || '#a855f7', 0.8),
                        hexToRgba(getCssVar('--primary') || '#667eea', 0.5)
                    ],
                    borderColor: [
                        hexToRgba(getCssVar('--primary') || '#667eea', 1),
                        hexToRgba(getCssVar('--danger') || '#ef4444', 1),
                        hexToRgba(getCssVar('--success') || '#10b981', 1),
                        hexToRgba(getCssVar('--accent') || '#a855f7', 1),
                        hexToRgba(getCssVar('--primary') || '#667eea', 0.8)
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + Number(value).toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        const pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 750
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = '$' + context.parsed.toLocaleString();
                                const total = financialData.expenses.reduce((a, b) => a + b.amount, 0);
                                if (!total) return label + ': ' + value;
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // Income input listener
        document.getElementById('income').addEventListener('input', function(e) {
            financialData.income = parseFloat(e.target.value) || 0;
            updateDisplay();
            saveData();
        });

        document.getElementById('incomeType').addEventListener('change', function(e) {
            if (e.target.value === 'monthly') {
                document.getElementById('monthlySection').style.display = 'block';
                document.getElementById('checkSection').style.display = 'none';
                financialData.income = parseFloat(document.getElementById('income').value) || 0;
                updateDisplay();
                saveData();
            } else {
                document.getElementById('monthlySection').style.display = 'none';
                document.getElementById('checkSection').style.display = 'block';
                updateIncomeFromChecks();
            }
        });

        function addCheck(ev) {
            const number = document.getElementById('checkNumber').value.trim();
            const amount = parseFloat(document.getElementById('checkAmount').value);
            if (!number || isNaN(amount) || amount <= 0) return;

            const check = {
                id: Date.now(),
                number: number,
                amount: amount
            };

            financialData.checks.push(check);

            document.getElementById('checkNumber').value = '';
            document.getElementById('checkAmount').value = '';

            updateIncomeFromChecks();
            renderChecks();
            showToast(`Added check #${number} for $${amount.toFixed(2)}`, 'info');
            burst(ev);
            updateAdvisor();
        }

        function deleteCheck(id) {
            const idx = financialData.checks.findIndex(c => c.id === id);
            if (idx !== -1) {
                financialData.checks.splice(idx, 1);
                updateIncomeFromChecks();
                renderChecks();
                showToast('Deleted check', 'warn');
                updateAdvisor();
            }
        }

        function renderChecks() {
            const list = document.getElementById('checkList');
            list.innerHTML = '';
            financialData.checks.forEach(check => {
                const item = document.createElement('div');
                item.className = 'expense-item';
                item.innerHTML = `
                    <div style="color: var(--text); font-weight: 600;">#${check.number}</div>
                    <div style="font-weight: 600; color: var(--text);">$${check.amount.toFixed(2)}</div>
                    <button class="delete-btn" onclick="deleteCheck(${check.id})">Delete</button>
                `;
                list.appendChild(item);
            });
        }

        function updateIncomeFromChecks() {
            financialData.income = financialData.checks.reduce((sum, c) => sum + c.amount, 0);
            updateDisplay();
            saveData();
        }

        // Add expense function (default dropdown, optional custom name)
        function addExpense(ev) {
            const nameEl = document.getElementById('expenseName');
            const name = (nameEl?.value || '').trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const catSel = document.getElementById('expenseCategory');
            let category = catSel.value;
            const customGroup = document.getElementById('customCategoryGroup');
            const customEl = document.getElementById('expenseCategoryCustom');
            const customVisible = customGroup && customGroup.style.display !== 'none';
            const customValue = (customEl?.value || '').trim();
            if (customVisible && customValue) category = customValue;

            if (!name) {
                shake('#expenseName');
                showToast('Enter a name for the expense', 'error');
                return;
            }
            if (!amount || amount <= 0) {
                shake('#expenseAmount');
                showToast('Enter a valid expense amount', 'error');
                return;
            }
            // Category comes from dropdown by default; uses custom if provided

            const expense = {
                id: Date.now(),
                name: name,
                amount: amount,
                category: category
            };

            financialData.expenses.push(expense);

            // Update categories and assign color for new categories
            if (!financialData.categories[category]) {
                financialData.categories[category] = 0;
            }
            if (!categoryColors[category]) {
                categoryColors[category] = getRandomColor();
            }
            financialData.categories[category] += amount;

            // Clear inputs
            if (nameEl) nameEl.value = '';
            document.getElementById('expenseAmount').value = '';
            if (catSel) catSel.value = 'Other';
            // Reset any custom UI
            if (customEl) customEl.value = '';
            if (customGroup) customGroup.style.display = 'none';
            
            updateDisplay();
            renderExpenses();
            renderFilterChips();
            showToast(`Added ${category} $${amount.toFixed(2)} ‚Äî ${name}`, 'success');
            burst(ev);
            // Auto-deduct from balance
            financialData.balance = (parseFloat(financialData.balance) || 0) - amount;
            const bInput = document.getElementById('balanceInput');
            if (bInput) bInput.value = String(financialData.balance.toFixed(2));
            animateValue('balanceDisplay', financialData.balance);
            updateBalanceClass();
            updateAdvisor();
            saveData();
        }

        // Delete expense function
        function deleteExpense(id) {
            const expenseIndex = financialData.expenses.findIndex(e => e.id === id);
            if (expenseIndex !== -1) {
                const expense = financialData.expenses[expenseIndex];
                financialData.categories[expense.category] -= expense.amount;
                if (financialData.categories[expense.category] <= 0) {
                    delete financialData.categories[expense.category];
                }
                financialData.expenses.splice(expenseIndex, 1);
                updateDisplay();
                renderExpenses();
                renderFilterChips();
                showToast('Expense deleted', 'warn');
                // Auto-adjust balance back when an expense is removed
                financialData.balance = (parseFloat(financialData.balance) || 0) + expense.amount;
                const bInput = document.getElementById('balanceInput');
                if (bInput) bInput.value = String(financialData.balance.toFixed(2));
                animateValue('balanceDisplay', financialData.balance);
                updateBalanceClass();
                updateAdvisor();
                saveData();
            }
        }

        // Edit and save expenses (default dropdown, optional custom name)
        function editExpense(id) {
            const expense = financialData.expenses.find(e => e.id === id);
            if (!expense) return;
            const list = document.getElementById('expenseList');
            const item = Array.from(list.children).find(el => el.dataset && el.dataset.id === String(id));
            if (!item) return;
            const defaultCats = ['Housing','Food','Transport','Utilities','Entertainment','Healthcare','Shopping','Other'];
            const uniqueCats = Array.from(new Set([...defaultCats, ...Object.keys(financialData.categories)]));
            const inList = uniqueCats.includes(expense.category);
            const options = uniqueCats.map(cat => `<option value="${cat}" ${cat===expense.category?'selected':''}>${cat}</option>`).join('');
            item.innerHTML = `
                <div class="edit-inline">
                    <div class="input-group" style="margin:0; flex: 2 1 200px;">
                        <label style="font-size:.8rem;">Name</label>
                        <input type="text" id="editExpenseName_${id}" value="${(expense.name||'').replace(/"/g,'&quot;')}" />
                    </div>
                    <div class="input-group" style="margin:0; flex: 1 1 140px;">
                        <label style="font-size:.8rem;">Amount ($)</label>
                        <input type="number" step="0.01" id="editExpenseAmount_${id}" value="${expense.amount.toFixed(2)}" />
                    </div>
                    <div class="input-group" style="margin:0; flex: 1 1 160px;">
                        <label style="font-size:.8rem;">Category</label>
                        <select id="editExpenseCategory_${id}">${options}</select>
                        <button type="button" id="editToggleCustom_${id}" class="text-btn">or name your own</button>
                    </div>
                    <div class="input-group" id="editCustomGroup_${id}" style="margin:0; flex: 1 1 160px; ${inList?'display:none;':''}">
                        <label style="font-size:.8rem;">Custom Category</label>
                        <input type="text" id="editExpenseCategoryCustom_${id}" value="${inList ? '' : expense.category.replace(/"/g,'&quot;')}" />
                    </div>
                    <div class="actions">
                        <button class="btn" style="padding:6px 12px;" onclick="saveExpenseEdit(${id})">Save</button>
                        <button class="delete-btn" style="padding:6px 12px;" onclick="renderExpenses(); renderFilterChips();">Cancel</button>
                    </div>
                </div>
            `;
            const toggle = document.getElementById(`editToggleCustom_${id}`);
            const grp = document.getElementById(`editCustomGroup_${id}`);
            toggle?.addEventListener('click', ()=>{
                if (!grp) return;
                const showing = grp.style.display !== 'none';
                grp.style.display = showing ? 'none' : '';
                if (!showing) document.getElementById(`editExpenseCategoryCustom_${id}`)?.focus();
            });
        }

        function saveExpenseEdit(id) {
            const expense = financialData.expenses.find(e => e.id === id);
            if (!expense) return;
            const nameEl = document.getElementById(`editExpenseName_${id}`);
            const amtEl = document.getElementById(`editExpenseAmount_${id}`);
            const catEl = document.getElementById(`editExpenseCategory_${id}`);
            const customGrp = document.getElementById(`editCustomGroup_${id}`);
            const customEl = document.getElementById(`editExpenseCategoryCustom_${id}`);
            const newName = (nameEl?.value || '').trim();
            const newAmount = parseFloat(amtEl?.value);
            let newCategory = (customGrp && customGrp.style.display !== 'none' && (customEl?.value || '').trim()) || catEl?.value;
            if (!newName) { showToast('Enter a name', 'error'); return; }
            if (isNaN(newAmount) || newAmount <= 0) { showToast('Enter a valid amount', 'error'); return; }
            if (!newCategory) { showToast('Enter a category', 'error'); return; }

            const oldAmount = parseFloat(expense.amount) || 0;
            const oldCategory = String(expense.category || 'Other');

            // Update categories map
            financialData.categories[oldCategory] = (financialData.categories[oldCategory] || 0) - oldAmount;
            if (financialData.categories[oldCategory] <= 0) { delete financialData.categories[oldCategory]; }
            if (!financialData.categories[newCategory]) financialData.categories[newCategory] = 0;
            if (!categoryColors[newCategory]) categoryColors[newCategory] = getRandomColor();
            financialData.categories[newCategory] += newAmount;

            // Update expense entry
            expense.name = newName;
            expense.amount = newAmount;
            expense.category = newCategory;

            // Adjust balance: expenses decrease balance, so deltaBalance = old - new
            const deltaBalance = oldAmount - newAmount;
            financialData.balance = (parseFloat(financialData.balance) || 0) + deltaBalance;
            const bInput = document.getElementById('balanceInput');
            if (bInput) bInput.value = String(financialData.balance.toFixed(2));
            animateValue('balanceDisplay', financialData.balance);
            updateBalanceClass();
            updateDisplay();
            renderExpenses();
            renderFilterChips();
            updateAdvisor();
            showToast('Expense updated', 'success');
            saveData();
        }

        // Render expenses list (includes name + edit, search/sort/group)
        let activeFilter = 'All';
        let searchQuery = '';
        let sortMode = 'recent';
        let groupByCat = false;
        const collapsedCategories = {};
        function formatMoney(n){ return '$' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
        function toggleCategory(cat){ collapsedCategories[cat] = !collapsedCategories[cat]; renderExpenses(); }
        function renderExpenses() {
            const expenseList = document.getElementById('expenseList');
            expenseList.innerHTML = '';

            // Base filter by category chip
            let list = financialData.expenses.filter(exp => activeFilter === 'All' || exp.category === activeFilter);
            // Search by name or category
            const q = (searchQuery||'').trim().toLowerCase();
            if (q) {
                list = list.filter(e => (e.name||'').toLowerCase().includes(q) || (e.category||'').toLowerCase().includes(q));
            }
            // Sort
            list = list.slice();
            if (sortMode === 'amountDesc') list.sort((a,b)=> (b.amount||0)-(a.amount||0));
            else if (sortMode === 'amountAsc') list.sort((a,b)=> (a.amount||0)-(b.amount||0));
            else if (sortMode === 'nameAsc') list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
            else if (sortMode === 'nameDesc') list.sort((a,b)=> (b.name||'').localeCompare(a.name||''));
            else /* recent */ list.sort((a,b)=> (b.id||0)-(a.id||0));

            if (!groupByCat) {
                // Flat list
                list.forEach(expense => {
                    const item = document.createElement('div');
                    item.className = 'expense-item';
                    item.dataset.id = String(expense.id);
                    const safeName = (expense.name || '').replace(/"/g,'&quot;');
                    const nameHtml = (expense.name && expense.name.trim()) ? `<div class="expense-name">${safeName}</div>` : '';
                    item.innerHTML = `
                        <div class="primary">
                            <span class="expense-category" style="background: ${categoryColors[expense.category]}">${expense.category}</span>
                            ${nameHtml}
                        </div>
                        <div class="amount">${formatMoney(expense.amount)}</div>
                        <div class="actions">
                            <button class="btn" style="padding:6px 10px;" onclick="editExpense(${expense.id})">Edit</button>
                            <button class="delete-btn" onclick="deleteExpense(${expense.id})">Delete</button>
                        </div>
                    `;
                    expenseList.appendChild(item);
                });
                return;
            }

            // Grouped by category: build sections
            const byCat = {};
            list.forEach(e => { (byCat[e.category] = byCat[e.category] || []).push(e); });
            const cats = Object.keys(byCat);
            // Order categories by total desc
            cats.sort((a,b)=> byCat[b].reduce((s,x)=>s+(x.amount||0),0) - byCat[a].reduce((s,x)=>s+(x.amount||0),0));
            cats.forEach(cat => {
                const items = byCat[cat];
                const total = items.reduce((s,x)=>s+(x.amount||0),0);
                const sec = document.createElement('div');
                sec.className = 'category-section' + (collapsedCategories[cat] ? ' collapsed' : '');
                const head = document.createElement('button');
                head.className = 'category-header';
                head.innerHTML = `
                    <span class="title"><span class="expense-category" style="background:${categoryColors[cat]||getCssVar('--primary')}">${cat}</span></span>
                    <span class="meta">${items.length} ‚Ä¢ ${formatMoney(total)} <span class="chev">‚ñæ</span></span>
                `;
                head.onclick = () => toggleCategory(cat);
                const body = document.createElement('div');
                body.className = 'category-items';
                body.style.display = collapsedCategories[cat] ? 'none' : 'block';
                items.forEach(expense => {
                    const row = document.createElement('div');
                    row.className = 'expense-item';
                    row.dataset.id = String(expense.id);
                    const safeName = (expense.name || '').replace(/"/g,'&quot;');
                    const nameHtml = (expense.name && expense.name.trim()) ? `<div class="expense-name">${safeName}</div>` : '';
                    row.innerHTML = `
                        <div class="primary">
                            ${nameHtml}
                        </div>
                        <div class="amount">${formatMoney(expense.amount)}</div>
                        <div class="actions">
                            <button class="btn" style="padding:6px 10px;" onclick="editExpense(${expense.id})">Edit</button>
                            <button class="delete-btn" onclick="deleteExpense(${expense.id})">Delete</button>
                        </div>
                    `;
                    body.appendChild(row);
                });
                sec.appendChild(head);
                sec.appendChild(body);
                expenseList.appendChild(sec);
            });
        }

        function renderFilterChips() {
            const chips = document.getElementById('filterChips');
            const cats = ['All', ...Object.keys(financialData.categories)];
            chips.innerHTML = '';
            cats.forEach(cat => {
                const el = document.createElement('button');
                el.className = 'chip' + (cat === activeFilter ? ' active' : '');
                el.setAttribute('data-label', cat);
                el.textContent = cat;
                el.style.setProperty('--chip-color', categoryColors[cat] || getCssVar('--primary'));
                el.onclick = () => { activeFilter = cat; renderExpenses(); renderFilterChips(); };
                chips.appendChild(el);
            });
        }

        // Update display function
        function updateDisplay() {
            const totalExpenses = financialData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const actualSavings = Math.max(0, parseFloat(financialData.savings) || 0); // your real saved amount
            const disposable = Math.max(0, (parseFloat(financialData.income) || 0) - totalExpenses); // simple: income ‚àí expenses
            const yearly = (parseFloat(financialData.income) || 0) * 12;

            // Update metric displays with animation
            animateValue('incomeDisplay', financialData.income);
            animateValue('yearlyDisplay', yearly);
            animateValue('expensesDisplay', totalExpenses);
            animateValue('savingsDisplay', actualSavings);
            animateValue('disposableDisplay', disposable);
            if (typeof financialData.balance === 'number') {
                animateValue('balanceDisplay', financialData.balance);
            }
            
            // Update bar chart
            barChart.data.datasets[0].data = [
                parseFloat(financialData.income) || 0,
                totalExpenses,
                actualSavings,
                disposable,
                financialData.balance || 0
            ];
            barChart.update();
            
            // Update pie chart
            const categories = Object.keys(financialData.categories);
            const categoryValues = categories.map(cat => financialData.categories[cat]);
            const colors = categories.map(cat => categoryColors[cat]);
            
            pieChart.data.labels = categories;
            pieChart.data.datasets[0].data = categoryValues;
            pieChart.data.datasets[0].backgroundColor = colors;
            pieChart.update();

            // Update Spend Rate ring
            const percent = financialData.income > 0 ? Math.min(100, Math.round((totalExpenses / financialData.income) * 100)) : 0;
            updateRing(percent);

            popMetrics();
            updateBalanceClass();
            // Advisor stays in sync
            updateAdvisor();
        }

        // List controls events
        const searchEl = document.getElementById('expenseSearch');
        const sortEl = document.getElementById('expenseSort');
        const groupEl = document.getElementById('groupByCategory');
        if (searchEl) searchEl.addEventListener('input', () => { searchQuery = searchEl.value || ''; renderExpenses(); });
        if (sortEl) sortEl.addEventListener('change', () => { sortMode = sortEl.value || 'recent'; renderExpenses(); });
        if (groupEl) groupEl.addEventListener('change', () => { groupByCat = !!groupEl.checked; renderExpenses(); });

        // Animate value changes with timer dedupe and robust parsing
        const valueTimers = {};
        function animateValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (valueTimers[elementId]) { clearInterval(valueTimers[elementId]); }
            const current = parseFloat((element.textContent || '').replace(/[^0-9.-]/g, '')) || 0;
            const steps = 20;
            const increment = (value - current) / steps;
            let step = 0;
            
            valueTimers[elementId] = setInterval(() => {
                step++;
                const newValue = current + (increment * step);
                element.textContent = '$' + newValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                if (step >= steps) {
                    clearInterval(valueTimers[elementId]);
                    element.textContent = '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            }, 25);
        }

        // Enter key support for inputs (use keydown)
        document.getElementById('expenseAmount').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { addExpense(); }
        });
        document.getElementById('checkAmount').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { addCheck(); }
        });

        function updateChartsForTheme() {
            try {
                const primary = getCssVar('--primary') || '#667eea';
                const danger = getCssVar('--danger') || '#ef4444';
                const success = getCssVar('--success') || '#10b981';
                const accent = getCssVar('--accent') || '#a855f7';
                // In Sleek mode, enforce pure white for chart labels/numbers for maximal contrast
                const isSleek = document.body.classList.contains('theme-sleek');
                const textColor = isSleek ? '#ffffff' : (getCssVar('--text') || '#374151');

                const bg = [
                    hexToRgba(primary, 0.8),
                    hexToRgba(danger, 0.8),
                    hexToRgba(success, 0.8),
                    hexToRgba(accent, 0.8),
                    hexToRgba(primary, 0.5)
                ];
                const border = [
                    hexToRgba(primary, 1),
                    hexToRgba(danger, 1),
                    hexToRgba(success, 1),
                    hexToRgba(accent, 1),
                    hexToRgba(primary, 0.8)
                ];
                barChart.data.datasets[0].backgroundColor = bg;
                barChart.data.datasets[0].borderColor = border;
                // Apply high-contrast tick/label colors per theme
                if (barChart.options && barChart.options.scales) {
                    if (barChart.options.scales.x && barChart.options.scales.x.ticks) {
                        barChart.options.scales.x.ticks.color = textColor;
                    }
                    if (barChart.options.scales.y && barChart.options.scales.y.ticks) {
                        barChart.options.scales.y.ticks.color = textColor;
                    }
                }
                barChart.update('none');

                // Update global text color for axes/legend/tooltips
                Chart.defaults.color = textColor;
                if (Chart.defaults.plugins && Chart.defaults.plugins.tooltip) {
                    // Ensure tooltip text is readable across themes
                    Chart.defaults.plugins.tooltip.titleColor = textColor;
                    Chart.defaults.plugins.tooltip.bodyColor = textColor;
                }
                // Update gauge theme colors
                if (typeof gaugeColors !== 'undefined') {
                    gaugeColors.primary = primary;
                    gaugeColors.accent = accent;
                    gaugeColors.danger = danger;
                    gaugeColors.surface = getCssVar('--gauge-bg') || '#ffffff';
                }
            } catch (e) { /* no-op */ }
        }

        // Theme toggle logic with persistence
        const themeToggle = document.getElementById('themeToggle');
        const modeNameEl = document.getElementById('modeName');
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'sleek') {
            document.body.classList.add('theme-sleek');
            if (themeToggle) themeToggle.checked = true;
        }
        updateChartsForTheme();
        // Set initial mode label
        function updateModeName() {
            if (!modeNameEl) return;
            modeNameEl.textContent = document.body.classList.contains('theme-sleek') ? 'Sleek' : 'Classic';
        }
        updateModeName();

        const prefersReduced = () => {
            try { return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; } catch { return false; }
        };

        function playMoonFx() {
            if (prefersReduced()) return;
            try {
                const moon = document.querySelector('.toggle-icon.moon');
                if (!moon) return;
                moon.classList.remove('glow-pulse');
                void moon.offsetWidth;
                moon.classList.add('glow-pulse');
                setTimeout(() => moon.classList.remove('glow-pulse'), 950);
            } catch {}
        }

        function burstAroundMoon() {
            if (prefersReduced()) return;
            try {
                const host = document.querySelector('.toggle-icon.moon');
                if (!host) return;
                const count = 8;
                const colors = [getCssVar('--accent') || '#06b6d4', getCssVar('--success') || '#22c55e', getCssVar('--primary') || '#8b5cf6'];
                for (let i = 0; i < count; i++) {
                    const p = document.createElement('span');
                    p.className = 'spark-particle';
                    const angle = (Math.PI * 2 * i / count) + (Math.random() * 0.6 - 0.3);
                    const dist = 18 + Math.random() * 14;
                    const x = Math.cos(angle) * dist;
                    const y = Math.sin(angle) * dist * 0.9;
                    p.style.setProperty('--x', x + 'px');
                    p.style.setProperty('--y', y + 'px');
                    p.style.setProperty('--rot', (Math.random()*40-20) + 'deg');
                    p.style.color = colors[i % colors.length];
                    p.style.background = 'currentColor';
                    p.style.animation = `sparkFly ${700 + Math.random()*300}ms cubic-bezier(.22,.61,.36,1) forwards`;
                    host.appendChild(p);
                    setTimeout(() => p.remove(), 1100);
                }
            } catch {}
        }

        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                const enabled = themeToggle.checked;
                document.body.classList.toggle('theme-sleek', enabled);
                localStorage.setItem('theme', enabled ? 'sleek' : 'classic');
                updateChartsForTheme();
                updateModeName();
                playMoonFx();
                burstAroundMoon();
            });
        }
        // FX always ON (no toggle)

        // Toggle prompts removed for a cleaner experience

        // Interactive: ripple on buttons
        document.addEventListener('click', function(e) {
            // Close any open tooltips when clicking away
            if (!e.target.closest('.info')) {
                document.querySelectorAll('.info[data-open="1"]').forEach(el => el.removeAttribute('data-open'));
            }
            const btn = e.target.closest('.btn');
            if (!btn) return;
            const rect = btn.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        });

        // Info tooltip (viewport-clamped, fixed layer)
        (function(){
            const layer = document.getElementById('tipLayer');
            let currentInfo = null;
            function hideTip(){ if (layer){ layer.style.display='none'; layer.setAttribute('aria-hidden','true'); layer.textContent=''; } currentInfo=null; }
            function showTip(info){
                if (!layer || !info) return; const text = info.getAttribute('data-tip')||''; if (!text) return;
                layer.textContent = text;
                layer.style.display = 'block'; layer.setAttribute('aria-hidden','false');
                // Position above the icon by default, clamp to viewport
                const rect = info.getBoundingClientRect();
                const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
                const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
                // Temporarily position to measure size
                layer.style.left = '0px'; layer.style.top = '0px';
                const lw = layer.offsetWidth; const lh = layer.offsetHeight;
                let left = rect.left + rect.width/2 - lw/2;
                const margin = 8;
                left = Math.max(margin, Math.min(left, vw - lw - margin));
                let top = rect.top - lh - 10; // above
                if (top < margin) top = rect.bottom + 10; // place below if not enough room
                layer.style.left = left + 'px';
                layer.style.top = top + 'px';
                currentInfo = info;
            }
            document.addEventListener('click', function(e){
                const info = e.target.closest('.info');
                if (!info) { hideTip(); return; }
                if (currentInfo === info && layer && layer.style.display==='block') { hideTip(); return; }
                showTip(info);
            });
            // Also support hover/focus for better discoverability
            document.addEventListener('mouseover', function(e){
                const info = e.target.closest('.info');
                if (info) showTip(info);
            });
            document.addEventListener('mouseout', function(e){
                if (e.target.closest && e.target.closest('.info')) hideTip();
            });
            document.addEventListener('focusin', function(e){
                const info = e.target.closest && e.target.closest('.info');
                if (info) showTip(info);
            });
            document.addEventListener('focusout', function(e){
                if (e.target.closest && e.target.closest('.info')) hideTip();
            });
            window.addEventListener('scroll', ()=>{ if (currentInfo) showTip(currentInfo); }, { passive:true });
            window.addEventListener('resize', ()=>{ if (currentInfo) showTip(currentInfo); });
            document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') hideTip(); });
        })();

        // Card tilt effect
        function attachTilt() {
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    if (prefersReduced()) return;
                    const rect = card.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    const tiltX = (y - 0.5) * -6;
                    const tiltY = (x - 0.5) * 6;
                    card.style.transform = `perspective(800px) rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = '';
                });
            });
        }

        // Toast notifications
        function showToast(message, type='info') {
            const cont = document.getElementById('toastContainer');
            // keep at most 2 toasts to avoid stacking on spam
            while (cont.children.length > 1) cont.firstChild.remove();
            const box = document.createElement('div');
            box.className = `toast ${type}`;
            box.textContent = message;
            cont.appendChild(box);
            // shorter display on narrow screens
            const isMobileView = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            const life = isMobileView ? 1600 : 2400;
            requestAnimationFrame(() => box.classList.add('show'));
            setTimeout(() => { box.classList.remove('show'); setTimeout(()=> box.remove(), 200); }, life);
        }

        // Shake invalid input
        function shake(selector) {
            const el = document.querySelector(selector);
            if (!el) return;
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 400);
        }

        // Emoji burst
        function burst(ev) {
            try {
                const origin = ev && ev.clientX ? {x: ev.clientX, y: ev.clientY} : {x: window.innerWidth/2, y: window.innerHeight/2};
                for (let i=0; i<12; i++) {
                    const span = document.createElement('span');
                    span.className = 'burst';
                    span.textContent = ['üí∏','‚ú®','üíú','üí∞','üéâ'][i%5];
                    document.body.appendChild(span);
                    const angle = Math.random()*2*Math.PI;
                    const dist = 60 + Math.random()*60;
                    const x = origin.x + Math.cos(angle)*dist;
                    const y = origin.y + Math.sin(angle)*dist;
                    span.style.left = origin.x + 'px';
                    span.style.top = origin.y + 'px';
                    requestAnimationFrame(() => {
                        span.style.transform = `translate(${x-origin.x}px, ${y-origin.y}px) scale(1)`;
                        span.style.opacity = '0';
                    });
                    setTimeout(() => span.remove(), 800);
                }
            } catch (_) {}
        }

        // Spend Rate ring helpers
        const ring = document.querySelector('#spendRing .ring-progress');
        const ringBg = document.querySelector('#spendRing .ring-bg');
        const R = 52, CIRC = 2 * Math.PI * R;
        if (ring) { ring.style.strokeDasharray = `${CIRC}`; ring.style.strokeDashoffset = `${CIRC}`; }
        if (ringBg) { ringBg.style.strokeDasharray = `${CIRC}`; ringBg.style.strokeDashoffset = '0'; }
        function updateRing(percent) {
            const label = document.getElementById('spendRateLabel');
            if (!ring || !label) return;
            const offset = CIRC * (1 - percent/100);
            ring.style.strokeDashoffset = `${offset}`;
            label.textContent = `${percent}%`;
            const col = percent < 50 ? getCssVar('--success') : (percent < 80 ? getCssVar('--primary') : getCssVar('--danger'));
            ring.style.stroke = col || '#10b981';
            ringBg.style.stroke = hexToRgba(col || '#10b981', 0.15);
        }

        // Pop metric values on update
        function popMetrics() {
            ['incomeDisplay','yearlyDisplay','expensesDisplay','savingsDisplay','disposableDisplay','balanceDisplay'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('pop');
                void el.offsetWidth; // reflow to restart animation
                el.classList.add('pop');
            });
        }

        // Reveal-on-scroll
        const io = new IntersectionObserver((entries)=>{
            entries.forEach(e=>{
                if (e.isIntersecting) e.target.classList.add('in-view');
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.card, .chart-container').forEach(el=>io.observe(el));

        // Attach interactivity
        attachTilt();

        // Load saved data and render initial UI
        loadData();
        // Normalize any legacy expenses to include name field
        if (Array.isArray(financialData.expenses)) {
            financialData.expenses = financialData.expenses.map(e => ({
                id: e.id || Date.now() + Math.random(),
                name: (typeof e.name === 'string' ? e.name : ''),
                amount: parseFloat(e.amount) || 0,
                category: e.category || 'Other'
            }));
        }
        // Ensure colors for existing categories
        Object.keys(financialData.categories || {}).forEach(cat => {
            if (!categoryColors[cat]) categoryColors[cat] = getRandomColor();
        });
        renderChecks();
        renderExpenses();
        renderFilterChips();
        const bInputInit = document.getElementById('balanceInput');
        if (bInputInit) bInputInit.value = String(financialData.balance.toFixed(2));
        const incomeInputInit = document.getElementById('income');
        if (incomeInputInit) incomeInputInit.value = String(financialData.income.toFixed(2));
        if (financialData.checks.length > 0) {
            document.getElementById('incomeType').value = 'checks';
            document.getElementById('monthlySection').style.display = 'none';
            document.getElementById('checkSection').style.display = 'block';
        }
        // Balance input handlers
        const setBalanceBtn = document.getElementById('setBalanceBtn');
        const balanceInput = document.getElementById('balanceInput');
        function updateBalanceClass() {
            const el = document.getElementById('balanceDisplay');
            if (!el) return;
            el.classList.remove('positive','negative','neutral');
            const val = parseFloat(financialData.balance) || 0;
            el.classList.add(val >= 0 ? 'positive' : 'negative');
        }
        function setBalanceFromInput() {
            const val = parseFloat(balanceInput.value);
            if (isNaN(val)) return;
            financialData.balance = val;
            animateValue('balanceDisplay', val);
            updateBalanceClass();
            showToast('Balance updated', 'info');
            refreshGauge();
            saveData();
        }
        if (setBalanceBtn) setBalanceBtn.addEventListener('click', setBalanceFromInput);
        if (balanceInput) balanceInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') setBalanceFromInput(); });
        updateBalanceClass();
        // Add Expense: toggle custom category input visibility via link
        const toggleCustomBtn = document.getElementById('toggleCustomCategory');
        const customCatGroup = document.getElementById('customCategoryGroup');
        if (toggleCustomBtn && customCatGroup) {
            toggleCustomBtn.addEventListener('click', () => {
                const showing = customCatGroup.style.display !== 'none';
                customCatGroup.style.display = showing ? 'none' : '';
                if (!showing) document.getElementById('expenseCategoryCustom')?.focus();
            });
        }
        // Gauge setup
        const gaugeCanvas = document.getElementById('balanceCanvas');
        const gaugeCtx = gaugeCanvas.getContext('2d');
        let phase = 0;
        const gaugeColors = {
            primary: getCssVar('--primary') || '#667eea',
            accent: getCssVar('--accent') || '#a855f7',
            danger: getCssVar('--danger') || '#ef4444',
            surface: getCssVar('--gauge-bg') || '#ffffff'
        };
        function getGoalDefault() {
            const base = financialData.income || 1000;
            return Math.max(100, Math.round(base));
        }
        let balanceGoal = parseFloat(localStorage.getItem('balanceGoal') || '');
        if (isNaN(balanceGoal) || balanceGoal <= 0) balanceGoal = getGoalDefault();
        const balanceGoalInput = document.getElementById('balanceGoalInput');
        const setGoalBtn = document.getElementById('setGoalBtn');
        if (balanceGoalInput) balanceGoalInput.value = String(balanceGoal.toFixed(2));
        if (setGoalBtn) setGoalBtn.addEventListener('click', () => {
            const v = parseFloat(balanceGoalInput.value);
            if (!isNaN(v) && v > 0) {
                balanceGoal = v;
                localStorage.setItem('balanceGoal', String(v));
                showToast('Goal updated', 'success');
                refreshGauge();
            }
        });
        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x+r, y);
            ctx.arcTo(x+w, y, x+w, y+h, r);
            ctx.arcTo(x+w, y+h, x, y+h, r);
            ctx.arcTo(x, y+h, x, y, r);
            ctx.arcTo(x, y, x+w, y, r);
            ctx.closePath();
        }
        function drawGauge(percent) {
            const dpr = window.devicePixelRatio || 1;
            const W = gaugeCanvas.clientWidth * dpr;
            const H = gaugeCanvas.clientHeight * dpr;
            if (Math.abs(W - gaugeCanvas.width) > 1 || Math.abs(H - gaugeCanvas.height) > 1) {
                gaugeCanvas.width = W; gaugeCanvas.height = H;
            }
            const ctx = gaugeCtx;
            ctx.clearRect(0,0,W,H);
            const pad = 16 * dpr;
            const radius = 22 * dpr;
            // Border and background
            drawRoundedRect(ctx, pad, pad, W-2*pad, H-2*pad, radius);
            ctx.fillStyle = gaugeColors.surface;
            ctx.fill();
            ctx.lineWidth = 2*dpr;
            ctx.strokeStyle = getCssVar('--gauge-border') || '#e5e7eb';
            ctx.stroke();
            // Clip region for liquid
            ctx.save();
            drawRoundedRect(ctx, pad, pad, W-2*pad, H-2*pad, radius);
            ctx.clip();
            const level = pad + (H-2*pad) * (1 - percent/100);
            const amp = (prefersReduced() ? 5 : 8) * dpr;
            const k = 2 * Math.PI / (80 * dpr);
            // Back wave
            ctx.beginPath();
            ctx.moveTo(0, H);
            for (let x=0; x<=W; x+=2*dpr) {
                const y = level + Math.sin((x + phase*0.8) * k) * amp * 0.8;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(W, H); ctx.closePath();
            ctx.fillStyle = hexToRgba(gaugeColors.accent, 0.5);
            ctx.fill();
            // Front wave
            ctx.beginPath();
            ctx.moveTo(0, H);
            for (let x=0; x<=W; x+=2*dpr) {
                const y = level + Math.sin((x + phase) * k) * amp;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(W, H); ctx.closePath();
            const posColor = hexToRgba(gaugeColors.primary, 0.9);
            const negColor = hexToRgba(gaugeColors.danger, 0.9);
            ctx.fillStyle = (financialData.balance >= 0) ? posColor : negColor;
            ctx.fill();
            ctx.restore();
            // Update DOM overlay labels (consistent on mobile + desktop)
            const main = document.getElementById('gaugeMain');
            const sub = document.getElementById('gaugeSub');
            if (main && sub) {
                main.textContent = `${Math.round(percent)}%`;
                sub.textContent = `of $${(balanceGoal||0).toLocaleString(undefined,{maximumFractionDigits:0})}`;
                // Position the label group so its bottom edge stays above the crest at center
                const centerX = W/2;
                const crestY = (pad + (H-2*pad) * (1 - percent/100) + Math.sin((centerX + phase) * k) * amp) / dpr; // px
                const defaultCenter = (H/2)/dpr; // px
                const margin = 16; // px
                const minCenter = pad/dpr + margin;
                const maxCenter = (H - pad)/dpr - margin;
                const label = document.querySelector('.gauge-label');
                if (label) {
                    // Measure label height in CSS pixels
                    const rect = label.getBoundingClientRect();
                    const labelHeight = (rect.height || 30);
                    const marginBottom = 10; // keep label bottom above crest
                    // compute center so bottom clears crest
                    let newCenter = crestY - marginBottom - (labelHeight/2);
                    // blend towards default center for smoother motion
                    const blend = 0.4; // lower = closer to crest
                    newCenter = newCenter * (1-blend) + (defaultCenter * blend);
                    newCenter = Math.max(minCenter, Math.min(newCenter, maxCenter));
                    label.style.setProperty('--gauge-center-top', `${newCenter}px`);
                }
                // No background around label to keep it fully transparent
            }
        }
        function computePercent() {
            const goal = balanceGoal || getGoalDefault();
            if (!goal || goal <= 0) return 0;
            const pct = (financialData.balance / goal) * 100;
            return Math.max(0, Math.min(100, pct));
        }
        function refreshGauge() { drawGauge(computePercent()); }
        function tick() { phase += 0.8; refreshGauge(); requestAnimationFrame(tick); }
        tick();
        updateDisplay();
        // Title ribbons animation is CSS-driven; no JS needed
        // Initialize advisor controls
        (function initAdvisor(){
            const reserveInput = document.getElementById('reservePercent');
            const applyBtn = document.getElementById('applyReserveBtn');
            const addBtn = document.getElementById('addPlannedBtn');
            const nameEl = document.getElementById('plannedName');
            const amtEl = document.getElementById('plannedAmount');
            const basisEl = document.getElementById('reserveBasis');
            const projEl = document.getElementById('useProjection');
            const cycleEl = document.getElementById('advisorCycle');
            const freqEl = document.getElementById('payFrequency');
            const anchorEl = document.getElementById('payAnchor');
            const monDayEl = document.getElementById('payMonthlyDay');
            let reserve = parseFloat(localStorage.getItem('reservePercent')||'');
            const migrated = localStorage.getItem('reserveDefaultMigrated') === '1';
            if (isNaN(reserve)) {
                reserve = 30; // default cushion aims for stronger savings
                try { localStorage.setItem('reservePercent', String(reserve)); } catch {}
            } else if (!migrated && reserve === 20) {
                // Migrate old default (20%) to new default (30%) once
                reserve = 30;
                try { 
                    localStorage.setItem('reservePercent', String(reserve));
                    localStorage.setItem('reserveDefaultMigrated', '1');
                } catch {}
            }
            if (reserveInput) reserveInput.value = String(reserve);
            const savedBasis = localStorage.getItem('reserveBasis') || 'both';
            if (basisEl) basisEl.value = savedBasis;
            const savedProj = localStorage.getItem('useProjection') || 'on';
            if (projEl) projEl.value = savedProj;
            const savedCycle = localStorage.getItem('advisorCycle') || 'month';
            if (cycleEl) cycleEl.value = savedCycle;
            const savedFreq = localStorage.getItem('payFrequency') || 'biweekly';
            if (freqEl) freqEl.value = savedFreq;
            const savedAnchor = localStorage.getItem('payAnchor');
            if (anchorEl && savedAnchor) anchorEl.value = savedAnchor;
            const savedMonDay = parseInt(localStorage.getItem('payMonthlyDay')||'15',10);
            if (monDayEl) monDayEl.value = String(isNaN(savedMonDay)?15:savedMonDay);
            function setReserve(){
                const v = parseFloat(reserveInput.value);
                if (!isNaN(v) && v >= 0) { localStorage.setItem('reservePercent', String(v)); }
                if (basisEl) localStorage.setItem('reserveBasis', basisEl.value || 'both');
                if (projEl) localStorage.setItem('useProjection', projEl.value || 'on');
                updateAdvisor(); showToast('Advisor updated', 'info');
            }
            if (applyBtn) applyBtn.addEventListener('click', setReserve);
            if (reserveInput) reserveInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') setReserve(); });
            if (basisEl) basisEl.addEventListener('change', setReserve);
            if (projEl) projEl.addEventListener('change', setReserve);
            function saveCycle(){
                if (cycleEl) localStorage.setItem('advisorCycle', cycleEl.value || 'month');
                if (freqEl) localStorage.setItem('payFrequency', freqEl.value || 'biweekly');
                if (anchorEl && anchorEl.value) localStorage.setItem('payAnchor', anchorEl.value);
                if (monDayEl && monDayEl.value) localStorage.setItem('payMonthlyDay', String(parseInt(monDayEl.value,10)||15));
                updateAdvisor();
            }
            if (cycleEl) cycleEl.addEventListener('change', saveCycle);
            if (freqEl) freqEl.addEventListener('change', saveCycle);
            if (anchorEl) anchorEl.addEventListener('change', saveCycle);
            if (monDayEl) monDayEl.addEventListener('input', saveCycle);
            if (addBtn) addBtn.addEventListener('click', ()=>{
                const n = (nameEl?.value || '').trim();
                const a = parseFloat(amtEl?.value);
                if (!n) { showToast('Enter a planned name', 'error'); return; }
                if (isNaN(a) || a<=0) { showToast('Enter a valid amount', 'error'); return; }
                financialData.planned.push({ id: Date.now(), name: n, amount: a });
                if (nameEl) nameEl.value = '';
                if (amtEl) amtEl.value = '';
                renderPlanned();
                updateAdvisor();
                saveData();
            });
            renderPlanned();
            updateAdvisor();
        })();

        // Savings Tree (SVG) logic + integration
        const savingsGoalBtn = document.getElementById('setSavingsGoalBtn');
        const goalInput = document.getElementById('savingsGoalInput');
        const amtInput = document.getElementById('savingsAmountInput');
        const depositBtn = document.getElementById('depositSavingsBtn');
        const withdrawBtn = document.getElementById('withdrawSavingsBtn');
        const savingsSetInput = document.getElementById('savingsSetInput');
        const updateSavedBtn = document.getElementById('updateSavedBtn');
        const treeWrap = document.getElementById('SavingsTree');
        function fmtMoney(n){ return '$' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
        function savingsPercent(){ const g = parseFloat(financialData.savingsGoal)||0; const s = parseFloat(financialData.savings)||0; if(!g) return 0; return Math.max(0, Math.min(100, (s/g)*100)); }
        function refreshTreeKPIs(){
            const s = parseFloat(financialData.savings)||0;
            const g = parseFloat(financialData.savingsGoal)||0;
            const pct = savingsPercent();
            const a = document.getElementById('savedNow'); if (a) a.textContent = fmtMoney(s);
            const b = document.getElementById('savedGoal'); if (b) b.textContent = fmtMoney(g);
            const c = document.getElementById('savedPct'); if (c) c.textContent = Math.round(pct) + '%';
        }
        let ST = null; // internal tree state
        function initSavingsTree(){
            if (!treeWrap) return;
            const seed = treeWrap.querySelector('#seed');
            const sproutStem = treeWrap.querySelector('#sproutStem');
            const sproutLeaf = treeWrap.querySelector('#sproutLeaf');
            const trunkFill = treeWrap.querySelector('#trunkFill');
            const branches = treeWrap.querySelector('#branches');
            const canopy = treeWrap.querySelector('#canopy');
            const shine = treeWrap.querySelector('#shine');
            const canopyCircles = Array.from(canopy.querySelectorAll('circle'));
            const groundShadow = treeWrap.querySelector('#groundShadow');
            const treeGroup = treeWrap.querySelector('#treeGroup');
            const ease = (t)=> t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
            const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
            ST = { progress:0, raf:0, start:0, from:0, to:0,
                updateVisual(p){
                    ST.progress = clamp(p,0,1);
                    // overall growth scale around base (50,84)
                    const gs = 0.80 + ST.progress * 0.50; // 0.80..1.30 (taller overall)
                    if (treeGroup) treeGroup.setAttribute('transform', `translate(50 84) scale(${gs.toFixed(3)}) translate(-50 -84)`);
                    // seed fades
                    const seedScale = 1 - ST.progress*1.1; if (seed) { seed.style.opacity = String(clamp(seedScale,0,1)); seed.style.display = (ST.progress > 0.25) ? 'none' : ''; }
                    // sprout phase (0..0.25)
                    const sprPhase = clamp(ST.progress/0.25, 0, 1);
                    const sprHeight = 84 - sprPhase*10;
                    if (sproutStem) sproutStem.setAttribute('d', `M50,84 L50,${sprHeight.toFixed(2)}`);
                    if (sproutLeaf) sproutLeaf.setAttribute('opacity', String(sprPhase));
                    const spr = treeWrap.querySelector('#sprout'); if (spr) spr.style.display = (ST.progress > 0.35) ? 'none' : '';
                    // trunk tapered fill
                    const trunkPhase = clamp((ST.progress - 0.15) / 0.75, 0, 1);
                    const topY = 84 - trunkPhase*44; // even taller trunk
                    const baseHalf = 2.6 + trunkPhase*3.1; // thicker base
                    const topHalf  = 1.1 + trunkPhase*1.4; // wider top
                    const leftTop  = (50 - topHalf).toFixed(2);
                    const rightTop = (50 + topHalf).toFixed(2);
                    const leftBase = (50 - baseHalf).toFixed(2);
                    const rightBase= (50 + baseHalf).toFixed(2);
                    const cY = (Number(topY)+84)/2;
                    const d = [
                      `M ${leftBase},84`,
                      `Q ${leftTop},${cY.toFixed(2)} ${leftTop},${topY.toFixed(2)}`,
                      `L ${rightTop},${topY.toFixed(2)}`,
                      `Q ${rightTop},${cY.toFixed(2)} ${rightBase},84`,
                      `Z`
                    ].join(' ');
                    if (trunkFill) trunkFill.setAttribute('d', d);
                    // branches (follow trunk and fade in sooner)
                    if (branches) {
                        const brPhase = clamp((ST.progress - 0.25)/0.55, 0, 1);
                        branches.setAttribute('opacity', String(brPhase));
                        // lift branches to stay closer to trunk top
                        const baseBranchAnchor = 68; // original average branch y
                        const branchDy = (topY - baseBranchAnchor) * brPhase;
                        branches.setAttribute('transform', `translate(0 ${branchDy.toFixed(2)})`);
                    }
                    // canopy grows in unison with trunk and anchors near trunk top
                    const canopyPhase = clamp((ST.progress - 0.12)/0.70, 0, 1);
                    if (canopy) {
                        canopy.setAttribute('opacity', String(canopyPhase));
                        const canopyDy = (topY - 56) * canopyPhase; // 56 is canopy base y
                        canopy.setAttribute('transform', `translate(0 ${canopyDy.toFixed(2)})`);
                        if (shine) shine.setAttribute('transform', `translate(0 ${canopyDy.toFixed(2)})`);
                    }
                    if (shine) shine.setAttribute('opacity', String(canopyPhase*0.7));
                    const baseR = 5 + canopyPhase*14; // fuller, larger crown
                    const settle = 1 + Math.sin(performance.now()/350)*0.02*(1 - (1-canopyPhase));
                    const jitter = [1.00, 0.92, 0.95, 0.88, 0.90, 1.05, 1.03, 0.97, 0.96];
                    canopyCircles.forEach((c,i)=>{
                        if (!c.dataset.cx0) { c.dataset.cx0 = c.getAttribute('cx'); c.dataset.cy0 = c.getAttribute('cy'); }
                        const r = baseR * jitter[i % jitter.length] * (1 - i*0.05) * settle;
                        c.setAttribute('r', r.toFixed(2));
                        const baseCx = parseFloat(c.dataset.cx0);
                        const baseCy = parseFloat(c.dataset.cy0);
                        const wind = Math.sin(performance.now()/900)*0.6;
                        const swayX = wind * (0.4 + (i%3)*0.2);
                        const swayY = Math.cos(performance.now()/1100 + i)*0.3;
                        c.setAttribute('cx', (baseCx + swayX).toFixed(2));
                        c.setAttribute('cy', (baseCy + swayY).toFixed(2));
                    });
                    // ground shadow
                    if (groundShadow) {
                        const rx = 5 + canopyPhase*14;
                        groundShadow.setAttribute('rx', rx.toFixed(2));
                        groundShadow.setAttribute('opacity', (0.05 + canopyPhase*0.25).toFixed(2));
                    }
                },
                animateTo(target){
                    const targetP = clamp(target,0,1);
                    if (ST.raf) cancelAnimationFrame(ST.raf);
                    ST.start = performance.now(); ST.from = ST.progress; ST.to = targetP;
                    const growing = targetP >= ST.from;
                    const dur = growing ? 1200 : 950; // grow a touch slower; shrink slightly snappier
                    const step = (now)=>{
                        const t = Math.min(1, (now - ST.start)/dur);
                        // Smooth sine ease for seamless motion
                        const easeInOut = (1 - Math.cos(Math.PI * t)) / 2;
                        const p = ST.from + (ST.to - ST.from) * easeInOut;
                        ST.updateVisual(p);
                        if (t<1) ST.raf = requestAnimationFrame(step); else ST.raf = 0;
                    };
                    ST.raf = requestAnimationFrame(step);
                }
            };
            // initial draw
            ST.updateVisual(0);
        }
        function refreshSavingsTree(immediate){
            refreshTreeKPIs();
            if (!ST) return;
            const g = parseFloat(financialData.savingsGoal)||0;
            const s = parseFloat(financialData.savings)||0;
            const p = g>0 ? s/g : 0;
            if (immediate) ST.updateVisual(p); else ST.animateTo(p);
        }
        function setSavingsGoal(){
            const v = parseFloat(goalInput?.value);
            if (isNaN(v) || v <= 0) { showToast('Enter a valid savings goal', 'error'); return; }
            financialData.savingsGoal = v; saveData(); refreshSavingsTree(true); showToast('Savings goal set','success');
        }
        function depositSavings(){
            const amt = parseFloat(amtInput?.value);
            if (isNaN(amt) || amt <= 0) { showToast('Enter a valid amount', 'error'); return; }
            const bal = parseFloat(financialData.balance)||0;
            if (amt > bal) { showToast('Not enough balance to deposit', 'error'); return; }
            financialData.balance = bal - amt;
            financialData.savings = (parseFloat(financialData.savings)||0) + amt;
            const bInput = document.getElementById('balanceInput'); if (bInput) bInput.value = String(financialData.balance.toFixed(2));
            animateValue('balanceDisplay', financialData.balance);
            updateBalanceClass();
            saveData(); refreshSavingsTree(false); updateAdvisor(); showToast('Deposited to savings','success');
        }
        function withdrawSavings(){
            const amt = parseFloat(amtInput?.value);
            if (isNaN(amt) || amt <= 0) { showToast('Enter a valid amount', 'error'); return; }
            const s = parseFloat(financialData.savings)||0;
            if (amt > s) { showToast('Amount exceeds savings', 'error'); return; }
            financialData.savings = s - amt;
            financialData.balance = (parseFloat(financialData.balance)||0) + amt;
            const bInput = document.getElementById('balanceInput'); if (bInput) bInput.value = String(financialData.balance.toFixed(2));
            animateValue('balanceDisplay', financialData.balance);
            updateBalanceClass();
            saveData(); refreshSavingsTree(false); updateAdvisor(); showToast('Withdrew from savings','warn');
        }
        if (goalInput) goalInput.value = String((parseFloat(financialData.savingsGoal)||0).toFixed(2));
        if (savingsGoalBtn) savingsGoalBtn.addEventListener('click', setSavingsGoal);
        if (goalInput) goalInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') setSavingsGoal(); });
        if (depositBtn) depositBtn.addEventListener('click', depositSavings);
        if (withdrawBtn) withdrawBtn.addEventListener('click', withdrawSavings);
        function setSavedAmount(){
            const v = parseFloat(savingsSetInput?.value);
            if (isNaN(v) || v < 0) { showToast('Enter a valid saved amount', 'error'); return; }
            financialData.savings = v;
            saveData(); refreshSavingsTree(false); updateAdvisor(); showToast('Saved amount updated','info');
        }
        if (updateSavedBtn) updateSavedBtn.addEventListener('click', setSavedAmount);
        if (savingsSetInput) savingsSetInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') setSavedAmount(); });
        if (savingsSetInput) savingsSetInput.value = String((parseFloat(financialData.savings)||0).toFixed(2));
        initSavingsTree();
        refreshSavingsTree(true);

        function renderPlanned(){
            const list = document.getElementById('plannedList');
            if (!list) return;
            list.innerHTML = '';
            (financialData.planned||[]).forEach(p => {
                const row = document.createElement('div');
                row.className = 'planned-item';
                row.dataset.id = String(p.id);
                row.innerHTML = `
                    <div class="name">${(p.name||'').replace(/"/g,'&quot;')}</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="amt">$${(parseFloat(p.amount)||0).toFixed(2)}</div>
                        <button class="delete-btn" onclick="deletePlanned(${p.id})">Delete</button>
                    </div>`;
                list.appendChild(row);
            });
        }

        function deletePlanned(id){
            const idx = (financialData.planned||[]).findIndex(p=>p.id===id);
            if (idx>=0) { financialData.planned.splice(idx,1); renderPlanned(); updateAdvisor(); saveData(); showToast('Planned removed','warn'); }
        }

        function daysBetween(a,b){ const MS=24*60*60*1000; return Math.max(0, Math.ceil((b.setHours(0,0,0,0)-a.setHours(0,0,0,0))/MS)); }
        function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
        function parseDateInput(val){ if (!val) return null; const d=new Date(val+'T00:00:00'); return isNaN(+d)?null:d; }
        function getNextPayday(today, freq, anchor, monthlyDay){
            const t = startOfDay(today);
            if (freq==='semimonthly'){
                const y = t.getFullYear(); const m = t.getMonth(); const d = t.getDate();
                const next1 = new Date(y, m, d <= 1 ? 1 : (d <= 15 ? 15 : 1), 0,0,0,0);
                if (d < 1) return next1; if (d < 15) return new Date(y,m,15); else return new Date(y,m+1,1);
            }
            if (freq==='monthly'){
                const day = Math.min(Math.max(1, monthlyDay||15),28);
                const y = t.getFullYear(); const m = t.getMonth(); const d = t.getDate();
                if (d < day) return new Date(y,m,day); else return new Date(y,m+1,day);
            }
            // weekly/biweekly require anchor
            const a = anchor ? startOfDay(anchor) : t;
            const period = (freq==='weekly') ? 7 : 14;
            const diffDays = daysBetween(a, t);
            const rem = diffDays % period;
            const daysToNext = rem===0 ? period : (period - rem);
            const next = new Date(t); next.setDate(t.getDate() + daysToNext); return next;
        }
        function getPrevPayday(today, freq, anchor, monthlyDay){
            const next = getNextPayday(today, freq, anchor, monthlyDay);
            const periodDays = freq==='weekly'?7: freq==='biweekly'?14: freq==='semimonthly'? (next.getDate()===1?16:15) : 30; // rough for monthly
            const prev = new Date(next); prev.setDate(next.getDate()-periodDays); return startOfDay(prev);
        }
        function sumExpensesBetween(start, end){
            const s0 = startOfDay(start), e0 = startOfDay(end);
            return (financialData.expenses||[]).reduce((sum,e)=>{
                const t = Number(e.id)||0; if(!t) return sum; const d = new Date(t);
                return (d >= s0 && d < e0) ? sum + (parseFloat(e.amount)||0) : sum;
            }, 0);
        }
        function dailyTotalsBetween(start, end){
            const s0 = startOfDay(start), e0 = startOfDay(end);
            const days = Math.max(1, daysBetween(s0, e0));
            const map = new Map();
            (financialData.expenses||[]).forEach(e=>{
                const t = Number(e.id)||0; if(!t) return; const d = startOfDay(new Date(t));
                if (d >= s0 && d < e0) {
                    const k = d.toISOString().slice(0,10);
                    map.set(k, (map.get(k)||0) + (parseFloat(e.amount)||0));
                }
            });
            const arr = [];
            for (let i=0;i<days;i++){
                const d = new Date(s0); d.setDate(s0.getDate()+i);
                const k = d.toISOString().slice(0,10);
                arr.push(map.get(k)||0);
            }
            return arr;
        }
        function trimmedMean(values, upperFrac=0.2, lowerFrac=0){
            const n = values.length; if (!n) return 0;
            const a = [...values].sort((x,y)=>x-y);
            const lo = Math.floor(n * Math.max(0, Math.min(0.49, lowerFrac)));
            const hi = Math.floor(n * Math.max(0, Math.min(0.49, upperFrac)));
            const slice = a.slice(lo, n-hi);
            const m = slice.length; if (!m) return a.reduce((s,v)=>s+v,0)/n;
            return slice.reduce((s,v)=>s+v,0)/m;
        }
        function expWeightedAvg(values){
            if (!values.length) return 0;
            const arr = values; // assume oldest..newest
            let wSum = 0, sum = 0;
            const decay = 0.5; // newer days count more
            let w = 1;
            for (let i=0;i<arr.length;i++){
                sum += arr[i]*w; wSum += w; w *= decay;
            }
            return wSum ? (sum/wSum) : 0;
        }
        function updateAdvisor(){
            try {
                const reservePct = parseFloat(localStorage.getItem('reservePercent')||'');
                const pct = (!isNaN(reservePct) ? reservePct : 30) / 100;
                const basis = localStorage.getItem('reserveBasis') || 'both';
                const useProj = (localStorage.getItem('useProjection') || 'on') === 'on';
                const income = parseFloat(financialData.income)||0;
                const balance = parseFloat(financialData.balance)||0;
                const planned = (financialData.planned||[]).reduce((s,p)=> s + (parseFloat(p.amount)||0), 0);
                // Reserve base selection
                const reserveBase = basis === 'balance' ? balance : basis === 'income' ? income : (balance + income);
                let reserve = Math.max(0, reserveBase * pct);
                const now = new Date();
                const cycle = (localStorage.getItem('advisorCycle')||'month');
                const freq = (localStorage.getItem('payFrequency')||'biweekly');
                const anchorVal = localStorage.getItem('payAnchor');
                const anchor = parseDateInput(anchorVal) || now;
                const monDay = parseInt(localStorage.getItem('payMonthlyDay')||'15',10)||15;
                let periodStart, periodEnd, daysLeft, daysGone;
                if (cycle==='paycheck'){
                    const next = getNextPayday(now, freq, anchor, monDay);
                    periodEnd = startOfDay(next);
                    const prev = getPrevPayday(now, freq, anchor, monDay);
                    periodStart = startOfDay(prev);
                    daysLeft = Math.max(1, daysBetween(startOfDay(now), periodEnd));
                    daysGone = Math.max(1, daysBetween(periodStart, startOfDay(now)));
                } else {
                    const y = now.getFullYear(); const m = now.getMonth();
                    periodStart = new Date(y, m, 1);
                    periodEnd = new Date(y, m+1, 1);
                    const daysInMonth = new Date(y, m+1, 0).getDate();
                    const day = now.getDate();
                    daysLeft = Math.max(1, daysInMonth - day + 1);
                    daysGone = Math.max(1, day - 1);
                }
                // Sum expenses in current period and build robust daily pace
                const expInPeriod = sumExpensesBetween(periodStart, now);
                const dailyMTD = expInPeriod / Math.max(1, daysGone);
                const totals = dailyTotalsBetween(periodStart, now);
                const recentWindow = Math.min(totals.length, 14);
                const recentArr = totals.slice(totals.length - recentWindow);
                const trimmed = trimmedMean(recentArr, 0.2, 0);
                const expAvg = expWeightedAvg(recentArr.slice(-Math.min(recentArr.length,7)).reverse()); // newest weighted highest
                const robustRecent = (recentArr.length ? ( (isNaN(trimmed)?0:trimmed)*0.5 + (isNaN(expAvg)?0:expAvg)*0.5 ) : 0);
                const recentWeight = Math.max(0.3, Math.min(1, recentArr.length/7));
                const dailyRaw = recentArr.length ? (recentWeight*robustRecent + (1-recentWeight)*dailyMTD) : dailyMTD;
                const daily = Math.max(0, isFinite(dailyRaw)?dailyRaw:0);
                const projectedRemaining = useProj ? Math.max(0, daily * daysLeft) : 0;
                // Cap reserve so it can't exceed available balance (prevents overshrink)
                reserve = Math.min(reserve, Math.max(0, balance));
                let safe = balance - planned - reserve - projectedRemaining;
                if (!isFinite(safe)) safe = 0;
                safe = Math.max(0, safe);
                const perDay = safe / daysLeft;
                const fmt = (n)=> '$' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
                const safeEl = document.getElementById('kpiSafeNow');
                const perDayEl = document.getElementById('kpiPerDay');
                const resEl = document.getElementById('kpiReserve');
                const planEl = document.getElementById('kpiPlanned');
                if (safeEl) safeEl.textContent = fmt(safe);
                if (perDayEl) perDayEl.textContent = fmt(perDay);
                if (resEl) resEl.textContent = fmt(reserve);
                if (planEl) planEl.textContent = fmt(planned);
                // breakdown
                const bBal = document.getElementById('xBalance'); if (bBal) bBal.textContent = fmt(balance);
                const bRes = document.getElementById('xReserve'); if (bRes) bRes.textContent = fmt(reserve);
                const bPln = document.getElementById('xPlanned'); if (bPln) bPln.textContent = fmt(planned);
                const bPrj = document.getElementById('xProjected'); if (bPrj) bPrj.textContent = fmt(projectedRemaining);
                const bSafe = document.getElementById('xSafe'); if (bSafe) bSafe.textContent = fmt(safe);
                const bPd = document.getElementById('xPerDay'); if (bPd) bPd.textContent = fmt(perDay);
                const bDays = document.getElementById('xDaysLeft'); if (bDays) bDays.textContent = String(daysLeft);
                const bPace = document.getElementById('xDailyPace'); if (bPace) bPace.textContent = fmt(daily) + '/day';
                const xBasis = document.getElementById('xBasis'); if (xBasis) xBasis.textContent = basis==='both'?'Both':basis[0].toUpperCase()+basis.slice(1);
            } catch {}
        }
    </script>
</body>
</html>
